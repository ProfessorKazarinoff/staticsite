<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Adding Google OAuth and system service to a Jupyter Hub server - Python for Undergraduate Engineers</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




<style type="text/css">

/*some stuff for output/input prompts*/
div.cell{border:1px solid transparent;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}div.cell.selected{border-radius:4px;border:thin #ababab solid}
div.cell.edit_mode{border-radius:4px;border:thin #008000 solid}
div.cell{width:100%;padding:5px 5px 5px 0;margin:0;outline:none}
div.prompt{min-width:11ex;padding:.4em;margin:0;font-family:monospace;text-align:right;line-height:1.21429em}
@media (max-width:480px){div.prompt{text-align:left}}div.inner_cell{display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;flex:1}
div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;line-height:1.21429em}
div.prompt:empty{padding-top:0;padding-bottom:0}
div.input{page-break-inside:avoid;display:-webkit-box;-webkit-box-orient:horizontal;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:horizontal;-moz-box-align:stretch;display:box;box-orient:horizontal;box-align:stretch;}
div.inner_cell{width:90%;}
div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;}
div.input_prompt{color:navy;border-top:1px solid transparent;}
div.output_wrapper{margin-top:5px;position:relative;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
div.output_scroll{height:24em;width:100%;overflow:auto;border-radius:4px;-webkit-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);-moz-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);}
div.output_collapsed{margin:0px;padding:0px;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
div.out_prompt_overlay{height:100%;padding:0px 0.4em;position:absolute;border-radius:4px;}
div.out_prompt_overlay:hover{-webkit-box-shadow:inset 0 0 1px #000000;-moz-box-shadow:inset 0 0 1px #000000;box-shadow:inset 0 0 1px #000000;background:rgba(240, 240, 240, 0.5);}
div.output_prompt{color:darkred;}

a.anchor-link:link{text-decoration:none;padding:0px 20px;visibility:hidden;}
h1:hover .anchor-link,h2:hover .anchor-link,h3:hover .anchor-link,h4:hover .anchor-link,h5:hover .anchor-link,h6:hover .anchor-link{visibility:visible;}
/* end stuff for output/input prompts*/


.highlight-ipynb .hll { background-color: #ffffcc }
.highlight-ipynb  { background: #f8f8f8; }
.highlight-ipynb .c { color: #408080; font-style: italic } /* Comment */
.highlight-ipynb .err { border: 1px solid #FF0000 } /* Error */
.highlight-ipynb .k { color: #008000; font-weight: bold } /* Keyword */
.highlight-ipynb .o { color: #666666 } /* Operator */
.highlight-ipynb .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight-ipynb .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight-ipynb .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight-ipynb .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight-ipynb .gd { color: #A00000 } /* Generic.Deleted */
.highlight-ipynb .ge { font-style: italic } /* Generic.Emph */
.highlight-ipynb .gr { color: #FF0000 } /* Generic.Error */
.highlight-ipynb .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight-ipynb .gi { color: #00A000 } /* Generic.Inserted */
.highlight-ipynb .go { color: #888888 } /* Generic.Output */
.highlight-ipynb .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight-ipynb .gs { font-weight: bold } /* Generic.Strong */
.highlight-ipynb .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight-ipynb .gt { color: #0044DD } /* Generic.Traceback */
.highlight-ipynb .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight-ipynb .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight-ipynb .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight-ipynb .kp { color: #008000 } /* Keyword.Pseudo */
.highlight-ipynb .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight-ipynb .kt { color: #B00040 } /* Keyword.Type */
.highlight-ipynb .m { color: #666666 } /* Literal.Number */
.highlight-ipynb .s { color: #BA2121 } /* Literal.String */
.highlight-ipynb .na { color: #7D9029 } /* Name.Attribute */
.highlight-ipynb .nb { color: #008000 } /* Name.Builtin */
.highlight-ipynb .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight-ipynb .no { color: #880000 } /* Name.Constant */
.highlight-ipynb .nd { color: #AA22FF } /* Name.Decorator */
.highlight-ipynb .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight-ipynb .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight-ipynb .nf { color: #0000FF } /* Name.Function */
.highlight-ipynb .nl { color: #A0A000 } /* Name.Label */
.highlight-ipynb .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight-ipynb .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight-ipynb .nv { color: #19177C } /* Name.Variable */
.highlight-ipynb .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight-ipynb .w { color: #bbbbbb } /* Text.Whitespace */
.highlight-ipynb .mf { color: #666666 } /* Literal.Number.Float */
.highlight-ipynb .mh { color: #666666 } /* Literal.Number.Hex */
.highlight-ipynb .mi { color: #666666 } /* Literal.Number.Integer */
.highlight-ipynb .mo { color: #666666 } /* Literal.Number.Oct */
.highlight-ipynb .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight-ipynb .sc { color: #BA2121 } /* Literal.String.Char */
.highlight-ipynb .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight-ipynb .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight-ipynb .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight-ipynb .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight-ipynb .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight-ipynb .sx { color: #008000 } /* Literal.String.Other */
.highlight-ipynb .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight-ipynb .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight-ipynb .ss { color: #19177C } /* Literal.String.Symbol */
.highlight-ipynb .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight-ipynb .vc { color: #19177C } /* Name.Variable.Class */
.highlight-ipynb .vg { color: #19177C } /* Name.Variable.Global */
.highlight-ipynb .vi { color: #19177C } /* Name.Variable.Instance */
.highlight-ipynb .il { color: #666666 } /* Literal.Number.Integer.Long */
</style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
div.entry-content {
  overflow: visible;
  padding: 8px;
}
.input_area {
  padding: 0.2em;
}

a.heading-anchor {
 white-space: normal;
}

.rendered_html
code {
 font-size: .8em;
}

pre.ipynb {
  color: black;
  background: #f7f7f7;
  border: none;
  box-shadow: none;
  margin-bottom: 0;
  padding: 0;
  margin: 0px;
  font-size: 13px;
}

/* remove the prompt div from text cells */
div.text_cell .prompt {
    display: none;
}

/* remove horizontal padding from text cells, */
/* so it aligns with outer body text */
div.text_cell_render {
    padding: 0.5em 0em;
}

img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}

div.collapseheader {
    width=100%;
    padding: 2px;
    cursor: pointer;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
}

</style>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript">
init_mathjax = function() {
    if (window.MathJax) {
        // MathJax loaded
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            },
            displayAlign: 'center', // Change this to 'center' to center equations.
            "HTML-CSS": {
                styles: {'.MathJax_Display': {"margin": 0}}
            }
        });
        MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    }
}
init_mathjax();
</script>
    <link href="/extra/favicon.ico" rel="icon">

<link rel="canonical" href="/drafts/add-google-oauth-and-system-service-to-jupyterhub.html">

        <meta name="author" content="Peter D. Kazarinoff" />
        <meta name="keywords" content="jupyter,jupyter hub,jupyter notebooks,python" />
        <meta name="description" content="This is the sixth part of a multi-part series that shows how to set up Jupyter Hub for a college class. In this post, we will add an authentication system so that users can log into our Jupyter Hub server using their college usernames and passwords. We will also set jupyterhub to run as a system service in the background which will allow us to work on the server and run jupyterhub at the same time." />

        <meta property="og:site_name" content="Python for Undergraduate Engineers" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Adding Google OAuth and system service to a Jupyter Hub server"/>
        <meta property="og:url" content="/drafts/add-google-oauth-and-system-service-to-jupyterhub.html"/>
        <meta property="og:description" content="This is the sixth part of a multi-part series that shows how to set up Jupyter Hub for a college class. In this post, we will add an authentication system so that users can log into our Jupyter Hub server using their college usernames and passwords. We will also set jupyterhub to run as a system service in the background which will allow us to work on the server and run jupyterhub at the same time."/>
        <meta property="article:published_time" content="2018-05-22" />
            <meta property="article:section" content="jupyter" />
            <meta property="article:tag" content="jupyter" />
            <meta property="article:tag" content="jupyter hub" />
            <meta property="article:tag" content="jupyter notebooks" />
            <meta property="article:tag" content="python" />
            <meta property="article:author" content="Peter D. Kazarinoff" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link href="/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>
        <link href="/static/css/custom.css" rel="stylesheet">





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Python for Undergraduate Engineers            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="/pages/about.html">
                             About
                          </a></li>
                         <li><a href="/pages/book.html">
                             Book
                          </a></li>
                         <li><a href="/pages/now.html">
                             Now
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
            <ol class="breadcrumb">
                <li><a href="" title="Python for Undergraduate Engineers"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="/category/jupyter.html" title="jupyter">jupyter</a></li>
                <li class="active">Adding Google OAuth and system service to a Jupyter Hub server</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/drafts/add-google-oauth-and-system-service-to-jupyterhub.html"
                       rel="bookmark"
                       title="Permalink to Adding Google OAuth and system service to a Jupyter Hub server">
                        Adding Google OAuth and system service to a Jupyter Hub server
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-05-22T12:40:00-07:00"> Tue 22 May 2018</time>
    </span>

            <span class="label label-default">Series</span>
            Part <built-in method index of str object at 0x000001D99C59D8B0> of 




<span class="label label-default">Tags</span>
	<a href="/tag/jupyter.html">jupyter</a>
        /
	<a href="/tag/jupyter-hub.html">jupyter hub</a>
        /
	<a href="/tag/jupyter-notebooks.html">jupyter notebooks</a>
        /
	<a href="/tag/python.html">python</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This is the sixth part of a multi-part series that shows how to set up Jupyter Hub for a college class. In this post, we will add an authentication system so that users can log into our Jupyter Hub server using their college usernames and passwords. We will also set <strong>jupyterhub</strong> to run as a system service in the background which will allow us to work on the server and run <strong>jupyterhub</strong> at the same time.</p>
<h3>Posts in this series</h3>
<ol>
<li><a href="/why-jupyter-hub.html">Why Jupyter Hub?</a> </li>
<li><a href="/ssh-keys-with-putty.html">Create ssh key, save to documents/ssh-keys</a></li>
<li><a href="/new-digital-ocean-droplet.html">Create a new Digital Ocean Droplet with a non-root sudo user</a></li>
<li><a href="/drafts/installing-jupyter-hub.html">Install Jupyter Hub on the server</a></li>
<li><a href="/drafts/add-ssl-and-domain-name-to-jupyterhub.html">Apply SSL, link a domain name to the server and configure nginx</a></li>
<li><strong>Connect OAuth to Jupyter Hub</strong> (this post)</li>
<li>Pre-populate each new user's directory tree to include three notebook assignments.</li>
</ol>
<h3>Last time</h3>
<p>In the last post, we succeeded in getting <strong>jupyterhub</strong> to run on https and use SSL certificates. We created SSL certificates, modified the nginx config and modified the jupyterhub config. At the end of it we were able to get a working version of jupyter hub running SSL security.</p>
<h3>Steps in this post:</h3>
<ol>
<li>Run <strong>jupterhub</strong> as a system service</li>
<li>Test local OAuth</li>
<li>Aquire google OAuth credentials</li>
<li>Modify jupyterhub_config.py to use google OAuth.</li>
<li>Start restart nginx and start jupyterhub. See if we can log in using google credentials.</li>
</ol>
<h3>1. Run <strong>jupterhub</strong> as a system service</h3>
<p>Working off of <a href="https://github.com/jupyterhub/jupyterhub/wiki/Run-jupyterhub-as-a-system-service">this wiki</a></p>
<p>To run jupyterhub as a system service, we need to create a service file in the <code>/etc/systemd/system</code> directory. <code>cd</code> into the directory and have a look around. You should see a couple files that end in <code>.service</code></p>
<div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /etc/systemd/system
$ ls
cloud-init.target.wants                network-online.target.wants
dbus-org.freedesktop.thermald.service  paths.target.wants
default.target.wants                   sockets.target.wants
final.target.wants                     sshd.service
getty.target.wants                     sysinit.target.wants
graphical.target.wants                 syslog.service
iscsi.service                          timers.target.wants
multi-user.target.wants
</pre></div>


<p>We'll create a new <code>.service</code> file called <code>jupyterhub.service</code></p>
<div class="highlight"><pre><span></span>$ sudo nano jupyterhub.service
</pre></div>


<p>In the file, add the following. Note that as part of the <code>PATH</code> environment variable <code>/home/peter/anaconda3/bin</code> is included. This is the path to our <strong>Anaconda</strong> environment. As part of the <code>ExecStart</code> we include a flag for our <code>jupyterhub_config.py</code> file. </p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Jupyterhub</span>
<span class="na">After</span><span class="o">=</span><span class="s">syslog.target network.target</span>

<span class="k">[Service]</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">&quot;PATH=/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/home/peter/anaconda3/bin&quot;</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/home/peter/anaconda3/bin/jupyterhub -f /home/peter/jupyterhub_config.py</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<p>Save and exit with [Ctrl-c] + [y]. Now we need to reload the system daemon and run <strong>jupyterhub</strong> as a system process using the command: <code>sudo systemctl &lt;start|stop|status&gt; jupyterhub</code></p>
<div class="highlight"><pre><span></span>$ sudo systemctl daemon-reload
$ sudo systemctl start jupyterhub
</pre></div>


<p>We can see if <strong>jupyterhub</strong>* is running with:</p>
<div class="highlight"><pre><span></span>$ sudo systemctl status jupyterhub

 Loaded: loaded <span class="o">(</span>/etc/systemd/system/jupyterhub.service<span class="p">;</span> 
 Active: active <span class="o">(</span>running<span class="o">)</span>
</pre></div>


<p>Now we can go to the server and log in as our non-root user, and log in as the other user we created <code>kendra</code></p>
<p>A couple times I thought that <strong>jupyterhub</strong> was running after using <code>systemctl start jupyterhub</code> but the hub wasn't working when I went to the hub's web address. It turned out that <strong>jupyterhub</strong> wasn't running when I keyed in <code>systemctl status jupyterhub</code>. Most times looking for an error and tracking down the the error worked, but one time it seemed to be a problem with the http-configurable-proxy. The following command will shut down the proxy if you get stuck like I did (insert the number corresponding to the configurable-http-proxy process after the <code>kill</code> command):</p>
<div class="highlight"><pre><span></span>$ ps aux <span class="p">|</span> grep configurable-http-proxy
$ <span class="nb">kill</span> <span class="c1">#### </span>
</pre></div>


<p>Something similar to this in jupyterhub_config.py</p>
<div class="highlight"><pre><span></span>#jupyterhub_config.py

c.LocalGoogleOAuthenticator.create_system_users = True
</pre></div>


<h3>2. Github Authenticator</h3>
<p>A problem now is that if we go to the admin page on jupyter hub, we can't add new users. The users have to be added to the server using PuTTY first and then can be added to jupyterhub with the admin pannel. This is OK for a small team or a couple users, but for a college class, creating a new user on the server for each student, then emailing out passwords... That will end up a mess. So we need to give jupyterhub the authority to create new users from the admin panel and we need a way to have users login with a user name and password that they already have.</p>
<p>One of the ways that students could log into Jupyter Hub is using their github credentials. This would force each student to set up a github account, but that might be worth it to give each student the exposure to git and github as a tools. So let's give the github authenticator a whirl. It is an authenticator that is pretty well documented for Jupyter Hub.</p>
<p>First we need to install <strong>oauthenticator</strong>. I couldn't find oauthenticator on conda-forge. If it's on conda-forge, I would install it from there rather than PyPI. But for this one, I used <strong>pip</strong>.</p>
<div class="highlight"><pre><span></span>$ pip install conda install oauthenticator
</pre></div>


<p>Now we need to log onto github and create an OAuth App and copy the client id and secret. The short version is:</p>
<p>github profile --&gt; settings --&gt; Developer Settings --&gt; Authorized OAuth Apps</p>
<p><img alt="github settings" src="/posts/jupyterhub/github_settings.png"></p>
<p><img alt="github developer settings" src="/posts/jupyterhub/github_developer_settings.png"></p>
<p><img alt="github register new applicaiton" src="/posts/jupyterhub/github_register_new_application.png"></p>
<p>We set the <strong>Homepage URL</strong> as:</p>
<p>https://notebooks.problemsolvingwithpython.com/</p>
<p>We set the <strong>Authorization call-back URL</strong> as</p>
<p>https://notebooks.problemsolvingwithpython.com/hub/oauth_callback</p>
<p><img alt="github register new app" src="/posts/jupyterhub/github_register_new_application.png"></p>
<p>on the App settings we need to copy two settings:</p>
<ul>
<li>client_id</li>
<li>client_secret</li>
</ul>
<p><img alt="github client id and secret" src="/posts/jupyterhub/github_client_id_and_secret.png"></p>
<p>These two long strings will need to be pasted into the jupyterhub_config.py file. </p>
<p>Now edit the <code>jupyterhub_config.py</code> file to include the following lines. Note that the <code>#c.Authenticator.whitelist</code> is commented out. We want to see if a github user can log onto the server (which will automatically create a new user and spawn a jupyter notebook server) and run notebooks. Once the server is working, then we can uncomment the white list and only allow in specific github usernames. Note the <code>c.LocalGitHubOAuthenticator.client_id</code> and <code>c.LocalGitHubOAuthenticator.client_secret</code> are the long strings from our github OAuth App.</p>
<div class="highlight"><pre><span></span><span class="c1">#jupyterhub_config.py</span>

<span class="kn">from</span> <span class="nn">oauthenticator.github</span> <span class="kn">import</span> <span class="n">LocalGitHubOAuthenticator</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">authenticator_class</span> <span class="o">=</span> <span class="n">LocalGitHubOAuthenticator</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGitHubOAuthenticator</span><span class="o">.</span><span class="n">oauth_callback_url</span> <span class="o">=</span> <span class="s1">&#39;https://notebooks.problemsolvingwithpython.com/hub/oauth_callback&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGitHubOAuthenticator</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxxxxxxxxxxxx&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGitHubOAuthenticator</span><span class="o">.</span><span class="n">client_secret</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#39;</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGitHubOAuthenticator</span><span class="o">.</span><span class="n">create_system_users</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c1">#c.Authenticator.whitelist = {&#39;peter&#39;,&#39;kendra&#39;}</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">admin_users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peter&#39;</span><span class="p">}</span>
</pre></div>


<p>Restart <strong>jupyterhub with</strong></p>
<div class="highlight"><pre><span></span>$ sudo systemctl stop jupyterhub
$ sudo systemctl start jupyterhub
$ sudo systemctl status jupyterhub
</pre></div>


<p>Browse over to the hub's URL and we should be able to log in with a github username and password. </p>
<p><img alt="Sign in with GitHub" src="/posts/jupyterhub/sign_in_with_github.PNG"></p>
<h3>3. Google Authenticator</h3>
<p>Now that the github authenticator works, we are going to get into the weeds of getting the google authenticator to work. Why google authenticator instead of github? Our college uses the gmail suite for both staff and students. When you log onto your college email, you are logging into gmail. You can use google calendar and google drive with your college email account. So it is probably best that we use the same google login that students use for their email as they use for their jupyterhub login. </p>
<p>First up we need to set up a google OAuth instance. I did this using my personal gmail account rather than my college gmail account. Some of the part of google suite are not available in my college profile like youtube and developer tabs. </p>
<p>When getting google OAuth credentials note:</p>
<ul>
<li>
<p>callback url: https://notebooks.problemsolvingwithpython.com/hub/oauth_callback</p>
</li>
<li>
<p>client id</p>
</li>
<li>client secret</li>
<li>hosted domain: college.edu</li>
<li>login service: College Name </li>
</ul>
<p>Then the following environmental variables need to be specified:</p>
<ul>
<li>OAUTH_CALLBACK_URL</li>
<li>OAUTH_CLIENT_ID</li>
<li>OAUTH_CLIENT_SECRET</li>
</ul>
<p>Once we get our google OAuth credentials, we need to edit <code>jupyterhub_conf.py</code></p>
<div class="highlight"><pre><span></span><span class="c1">#jupyterhub_conf.py</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">c</span><span class="o">.</span><span class="n">Spawner</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;/home/peter/anaconda3/bin/jupyterhub-singleuser&#39;</span>

<span class="c1"># For Google OAuth Authentication</span>
<span class="kn">from</span> <span class="nn">oauthenticator.google</span> <span class="kn">import</span> <span class="n">LocalGoogleOAuthenticator</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">authenticator_class</span> <span class="o">=</span> <span class="n">LocalGoogleOAuthenticator</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">create_system_users</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">hosted_domain</span> <span class="o">=</span> <span class="s1">&#39;pcc.edu&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">login_service</span> <span class="o">=</span> <span class="s1">&#39;Portland Community College&#39;</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">oauth_callback_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OAUTH_CALLBACK_URL&#39;</span><span class="p">]</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">oauth_client_id</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OAUTH_CLIENT_ID&#39;</span><span class="p">]</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">oauth_client_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OAUTH_CLIENT_SECRET&#39;</span><span class="p">]</span>
<span class="c1">#c.JupyterHub.cookie_secret_file = &#39;/srv/jupyterhub/jupyterhub_cookie_secret&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">add_user_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;adduser&#39;</span><span class="p">,</span> <span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;--gecos&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;--disabled-password&#39;</span><span class="p">,</span> <span class="s1">&#39;--force-badname&#39;</span><span class="p">]</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">whitelist</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peter.kazarinoff&#39;</span><span class="p">,</span><span class="s1">&#39;peter&#39;</span><span class="p">,</span><span class="s1">&#39;sergio.amador&#39;</span><span class="p">,</span><span class="s1">&#39;dan.kruger&#39;</span><span class="p">}</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">admin_users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peter.kazarinoff&#39;</span><span class="p">}</span>
</pre></div>


<p>This little line:</p>
<div class="highlight"><pre><span></span>c.Authenticator.add_user_cmd = [&#39;adduser&#39;, &#39;-q&#39;, &#39;--gecos&#39;, &#39;&quot;&quot;&#39;, &#39;--disabled-password&#39;, &#39;--force-badname&#39;]
</pre></div>


<p>was a real gottacha. Our college email addresses are in the form</p>
<p>firstname.lastname@college.edu </p>
<p>So jupyterhub was trying to create these users that have dots <code>.</code> in their usernames. This doesn't work in linux. I tried creating a new user with a dot in their username and it asked me to use the <code>--force-badname</code> flag. So that is what we have to add to the <code>c.Authenticator.add_user_cmd</code> list. Otherwise the users will be able to authenticate, but they won't get a new account on the server and they won't be able to run notebooks.</p>
<p>Restart jupyterhub and browse to the web address</p>
<div class="highlight"><pre><span></span>$ sudo systemctl stop jupyterhub
$ sudo systemctl start jupyterhub
$ sudo systemctl status jupyterhub
<span class="c1"># [Ctrl + c] to exit</span>
</pre></div>


<p>The login window should look something like:</p>
<p><img alt="Sign in with google" src="/posts/jupyterhub/sign_in_with_google.PNG"></p>
<h3>Summary</h3>
<p>In this post, We will also set <strong>jupyterhub</strong> to run as a system service in the background which will allow us to work on the server and run <strong>jupyterhub</strong> at the same time. Then we added a github authentication system so that users could log into our Jupyter Hub server using their github usernames and passwords. Then we modified the authentication system to use gmail user names and passwords even if the usernames contained a dot. </p>
<h3>Next Steps</h3>
<p>Up next we will see if we can populate each new user's working directory tree with a couple of notebooks that will be the three labs of the quarter. We'll see if we can pull these up from github so that they can be easily edited and viewed by the students before the quarter starts. </p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="/new-digital-ocean-droplet.html">Creating a new Digital Ocean Droplet</a></li>
        <li><a href="/ssh-keys-with-putty.html">Create an SSH Key with PuTTYgen</a></li>
        <li><a href="/why-jupyter-hub.html">Why Jupyter Hub?</a></li>
        <li><a href="/diffusion-problem-python-pint.html">Diffusion Calculation with Python and Pint</a></li>
        <li><a href="/opening-a-jupyter-notebook-on-windows.html">Opening a Jupyter Notebook on Windows</a></li>
    </ul>
</section>
<section class="well" id="related-posts">
    <h4>Article <built-in method index of str object at 0x000001D99C59D8B0> of the  series</h4>
</section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="/extra/gear-wrench-icon-512-278694.png"/>
        </p>
    <p>
      <strong>About Peter Kazarinoff</strong><br/>
        I teach engineering at a community college in the Pacific Northwest. I am interested in programming and how to help students. Here I mostly blog about Python, MATLAB and how programing can be incorporated into engineering education.
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="/new-digital-ocean-droplet.html">Creating a new Digital Ocean Droplet</a></li>
    <li class="list-group-item"><a href="/ssh-keys-with-putty.html">Create an SSH Key with PuTTYgen</a></li>
    <li class="list-group-item"><a href="/why-jupyter-hub.html">Why Jupyter Hub?</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group list-inline tagcloud" id="tags">
    <li class="list-group-item tag-3">
      <a href="/tag/anaconda.html">anaconda</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/blog.html">blog</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/engineering.html">engineering</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="/tag/esp8266.html">esp8266</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/jupyter.html">jupyter</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/jupyter-hub.html">jupyter hub</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="/tag/jupyter-notebooks.html">jupyter notebooks</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="/tag/micropython.html">micropython</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="/tag/pelican.html">pelican</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="/tag/python.html">python</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->

<!-- Sidebar/Series -->
<li class="list-group-item">
  <h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Series</span></h4>
  <ul class="list-group">
  </ul>
</li>
<!-- End Sidebar/Series -->


<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/professorkazarinoff">@professorkazarinoff</a> on GitHub
</li>
<!-- End Sidebar/Github -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Peter Kazarinoff
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>

    <script src="/static/js/custom.js"></script>


<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = '/theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  github.showRepos({
    user: 'professorkazarinoff',
    count: 5,
    skip_forks: true,
    target: '#gh_repos'
  });
});
</script>
<script src="/theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-116330557-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>
</body>
</html>