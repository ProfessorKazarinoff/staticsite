<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Adding Google OAuth and system service to a Jupyter Hub server - Python for Undergraduate Engineers</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




<style type="text/css">

/*some stuff for output/input prompts*/
div.cell{border:1px solid transparent;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}div.cell.selected{border-radius:4px;border:thin #ababab solid}
div.cell.edit_mode{border-radius:4px;border:thin #008000 solid}
div.cell{width:100%;padding:5px 5px 5px 0;margin:0;outline:none}
div.prompt{min-width:11ex;padding:.4em;margin:0;font-family:monospace;text-align:right;line-height:1.21429em}
@media (max-width:480px){div.prompt{text-align:left}}div.inner_cell{display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;flex:1}
div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;line-height:1.21429em}
div.prompt:empty{padding-top:0;padding-bottom:0}
div.input{page-break-inside:avoid;display:-webkit-box;-webkit-box-orient:horizontal;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:horizontal;-moz-box-align:stretch;display:box;box-orient:horizontal;box-align:stretch;}
div.inner_cell{width:90%;}
div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;}
div.input_prompt{color:navy;border-top:1px solid transparent;}
div.output_wrapper{margin-top:5px;position:relative;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
div.output_scroll{height:24em;width:100%;overflow:auto;border-radius:4px;-webkit-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);-moz-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);}
div.output_collapsed{margin:0px;padding:0px;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
div.out_prompt_overlay{height:100%;padding:0px 0.4em;position:absolute;border-radius:4px;}
div.out_prompt_overlay:hover{-webkit-box-shadow:inset 0 0 1px #000000;-moz-box-shadow:inset 0 0 1px #000000;box-shadow:inset 0 0 1px #000000;background:rgba(240, 240, 240, 0.5);}
div.output_prompt{color:darkred;}

a.anchor-link:link{text-decoration:none;padding:0px 20px;visibility:hidden;}
h1:hover .anchor-link,h2:hover .anchor-link,h3:hover .anchor-link,h4:hover .anchor-link,h5:hover .anchor-link,h6:hover .anchor-link{visibility:visible;}
/* end stuff for output/input prompts*/


.highlight-ipynb .hll { background-color: #ffffcc }
.highlight-ipynb  { background: #f8f8f8; }
.highlight-ipynb .c { color: #408080; font-style: italic } /* Comment */
.highlight-ipynb .err { border: 1px solid #FF0000 } /* Error */
.highlight-ipynb .k { color: #008000; font-weight: bold } /* Keyword */
.highlight-ipynb .o { color: #666666 } /* Operator */
.highlight-ipynb .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight-ipynb .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight-ipynb .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight-ipynb .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight-ipynb .gd { color: #A00000 } /* Generic.Deleted */
.highlight-ipynb .ge { font-style: italic } /* Generic.Emph */
.highlight-ipynb .gr { color: #FF0000 } /* Generic.Error */
.highlight-ipynb .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight-ipynb .gi { color: #00A000 } /* Generic.Inserted */
.highlight-ipynb .go { color: #888888 } /* Generic.Output */
.highlight-ipynb .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight-ipynb .gs { font-weight: bold } /* Generic.Strong */
.highlight-ipynb .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight-ipynb .gt { color: #0044DD } /* Generic.Traceback */
.highlight-ipynb .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight-ipynb .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight-ipynb .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight-ipynb .kp { color: #008000 } /* Keyword.Pseudo */
.highlight-ipynb .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight-ipynb .kt { color: #B00040 } /* Keyword.Type */
.highlight-ipynb .m { color: #666666 } /* Literal.Number */
.highlight-ipynb .s { color: #BA2121 } /* Literal.String */
.highlight-ipynb .na { color: #7D9029 } /* Name.Attribute */
.highlight-ipynb .nb { color: #008000 } /* Name.Builtin */
.highlight-ipynb .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight-ipynb .no { color: #880000 } /* Name.Constant */
.highlight-ipynb .nd { color: #AA22FF } /* Name.Decorator */
.highlight-ipynb .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight-ipynb .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight-ipynb .nf { color: #0000FF } /* Name.Function */
.highlight-ipynb .nl { color: #A0A000 } /* Name.Label */
.highlight-ipynb .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight-ipynb .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight-ipynb .nv { color: #19177C } /* Name.Variable */
.highlight-ipynb .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight-ipynb .w { color: #bbbbbb } /* Text.Whitespace */
.highlight-ipynb .mf { color: #666666 } /* Literal.Number.Float */
.highlight-ipynb .mh { color: #666666 } /* Literal.Number.Hex */
.highlight-ipynb .mi { color: #666666 } /* Literal.Number.Integer */
.highlight-ipynb .mo { color: #666666 } /* Literal.Number.Oct */
.highlight-ipynb .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight-ipynb .sc { color: #BA2121 } /* Literal.String.Char */
.highlight-ipynb .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight-ipynb .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight-ipynb .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight-ipynb .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight-ipynb .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight-ipynb .sx { color: #008000 } /* Literal.String.Other */
.highlight-ipynb .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight-ipynb .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight-ipynb .ss { color: #19177C } /* Literal.String.Symbol */
.highlight-ipynb .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight-ipynb .vc { color: #19177C } /* Name.Variable.Class */
.highlight-ipynb .vg { color: #19177C } /* Name.Variable.Global */
.highlight-ipynb .vi { color: #19177C } /* Name.Variable.Instance */
.highlight-ipynb .il { color: #666666 } /* Literal.Number.Integer.Long */
</style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
div.entry-content {
  overflow: visible;
  padding: 8px;
}
.input_area {
  padding: 0.2em;
}

a.heading-anchor {
 white-space: normal;
}

.rendered_html
code {
 font-size: .8em;
}

pre.ipynb {
  color: black;
  background: #f7f7f7;
  border: none;
  box-shadow: none;
  margin-bottom: 0;
  padding: 0;
  margin: 0px;
  font-size: 13px;
}

/* remove the prompt div from text cells */
div.text_cell .prompt {
    display: none;
}

/* remove horizontal padding from text cells, */
/* so it aligns with outer body text */
div.text_cell_render {
    padding: 0.5em 0em;
}

img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}

div.collapseheader {
    width=100%;
    padding: 2px;
    cursor: pointer;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
}

</style>

<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
<script type="text/javascript">
init_mathjax = function() {
    if (window.MathJax) {
        // MathJax loaded
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            },
            displayAlign: 'left', // Change this to 'center' to center equations.
            "HTML-CSS": {
                styles: {'.MathJax_Display': {"margin": 0}}
            }
        });
        MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
    }
}
init_mathjax();
</script>
    <link href="./extra/favicon.ico" rel="icon">

<link rel="canonical" href="./add-google-oauth-and-system-service-to-jupyterhub.html">

        <meta name="author" content="Peter D. Kazarinoff" />
        <meta name="keywords" content="jupyter,jupyter hub,jupyter notebooks,python" />
        <meta name="description" content="This is the sixth part of a multi-part series that shows how to set up Jupyter Hub for a college class. In this post, we will set up jupyterhub to run as a system service in the background which will allow us to work on the server and run jupyterhub at the same time. Then we will add an authentication system so that users can log into our Jupyter Hub server using github usernames and passwords. Finally we will modify the authentication system so that users can log into our Jupyer Hub server using their google usernames and passwords. The same user name and password a student uses to access their college email." />

        <meta property="og:site_name" content="Python for Undergraduate Engineers" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Adding Google OAuth and system service to a Jupyter Hub server"/>
        <meta property="og:url" content="./add-google-oauth-and-system-service-to-jupyterhub.html"/>
        <meta property="og:description" content="This is the sixth part of a multi-part series that shows how to set up Jupyter Hub for a college class. In this post, we will set up jupyterhub to run as a system service in the background which will allow us to work on the server and run jupyterhub at the same time. Then we will add an authentication system so that users can log into our Jupyter Hub server using github usernames and passwords. Finally we will modify the authentication system so that users can log into our Jupyer Hub server using their google usernames and passwords. The same user name and password a student uses to access their college email."/>
        <meta property="article:published_time" content="2018-05-27" />
            <meta property="article:section" content="jupyter" />
            <meta property="article:tag" content="jupyter" />
            <meta property="article:tag" content="jupyter hub" />
            <meta property="article:tag" content="jupyter notebooks" />
            <meta property="article:tag" content="python" />
            <meta property="article:author" content="Peter D. Kazarinoff" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/native.css" rel="stylesheet">
    <link href="./theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>
        <link href="./static/css/custom.css" rel="stylesheet">





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
Python for Undergraduate Engineers            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/about.html">
                             About
                          </a></li>
                         <li><a href="./pages/book.html">
                             Book
                          </a></li>
                         <li><a href="./pages/now.html">
                             Now
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
              <li><a href="./archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
            <ol class="breadcrumb">
                <li><a href="." title="Python for Undergraduate Engineers"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="./category/jupyter.html" title="jupyter">jupyter</a></li>
                <li class="active">Adding Google OAuth and system service to a Jupyter Hub server</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./add-google-oauth-and-system-service-to-jupyterhub.html"
                       rel="bookmark"
                       title="Permalink to Adding Google OAuth and system service to a Jupyter Hub server">
                        Adding Google OAuth and system service to a Jupyter Hub server
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-05-27T12:40:00-07:00"> Sun 27 May 2018</time>
    </span>

            <span class="label label-default">Series</span>
            Part 6 of Jupyter Hub




<span class="label label-default">Tags</span>
	<a href="./tag/jupyter.html">jupyter</a>
        /
	<a href="./tag/jupyter-hub.html">jupyter hub</a>
        /
	<a href="./tag/jupyter-notebooks.html">jupyter notebooks</a>
        /
	<a href="./tag/python.html">python</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This is the sixth part of a multi-part series that shows how to set up Jupyter Hub for a college class. In this post, we will set up <strong>jupyterhub</strong> to run as a system service in the background which will allow us to work on the server and run <strong>jupyterhub</strong> at the same time. Then we will add an authentication system so that users can log into our Jupyter Hub server using github usernames and passwords. Finally we will modify the authentication system so that users can log into our Jupyer Hub server using their google usernames and passwords. The same user name and password a student uses to access their college email.</p>
<h3 id="posts-in-this-series">Posts in this series</h3>
<ol>
<li><a href="./why-jupyter-hub.html">Why Jupyter Hub?</a> </li>
<li><a href="./ssh-keys-with-putty.html">Create ssh key, save to documents/ssh-keys</a></li>
<li><a href="./new-digital-ocean-droplet.html">Create a new Digital Ocean Droplet with a non-root sudo user</a></li>
<li><a href="./installing-jupyter-hub.html">Install Jupyter Hub on the server</a></li>
<li><a href="./add-ssl-and-domain-name-to-jupyterhub.html">Apply SSL, link a domain name to the server and configure nginx</a></li>
<li><strong>Connect OAuth to Jupyter Hub</strong> (this post)</li>
<li>Pre-populate each new user's directory tree to include three notebook assignments.</li>
</ol>
<h3 id="last-time">Last time</h3>
<p>In the last post, we succeeded in getting <strong>jupyterhub</strong> to run on https and use SSL certificates. We created SSL certificates, modified the nginx config and modified the <strong>jupyterhub</strong> config. At the end of it we were able to get a working version of jupyter hub running SSL security.</p>
<h3 id="steps-in-this-post">Steps in this post:</h3>
<ol>
<li>Run <strong>jupterhub</strong> as a system service</li>
<li>Test local OAuth</li>
<li>Acquire github OAuth credentials</li>
<li>Modify jupyterhub_config.py to use github OAuth</li>
<li>Acquire google OAuth credentials</li>
<li>Modify jupyterhub_config.py to use google OAuth</li>
</ol>
<p><br></p>
<h3 id="1-run-jupterhub-as-a-system-service">1. Run <strong>jupterhub</strong> as a system service</h3>
<p>Working off of <a href="https://github.com/jupyterhub/jupyterhub/wiki/Run-jupyterhub-as-a-system-service">this wiki</a></p>
<p>To run <strong>jupyterhub</strong> as a system service, we need to create a service file in the <code>/etc/systemd/system</code> directory. <code>cd</code> into the directory and have a look around. You should see a couple files that end in <code>.service</code></p>
<div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /etc/systemd/system
$ ls
cloud-init.target.wants                network-online.target.wants
dbus-org.freedesktop.thermald.service  paths.target.wants
default.target.wants                   sockets.target.wants
final.target.wants                     sshd.service
getty.target.wants                     sysinit.target.wants
graphical.target.wants                 syslog.service
iscsi.service                          timers.target.wants
multi-user.target.wants
</pre></div>


<p>We'll create a new <code>.service</code> file called <code>jupyterhub.service</code></p>
<div class="highlight"><pre><span></span>$ sudo nano jupyterhub.service
</pre></div>


<p>In the file, add the following. Note that as part of the <code>PATH</code> environment variable <code>/home/peter/anaconda3/bin</code> is included. This is the path to our <strong>Anaconda</strong> environment. As part of the <code>ExecStart</code> we include a flag for our <code>jupyterhub_config.py</code> file. </p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Jupyterhub</span>
<span class="na">After</span><span class="o">=</span><span class="s">syslog.target network.target</span>

<span class="k">[Service]</span>
<span class="na">User</span><span class="o">=</span><span class="s">root</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">&quot;PATH=/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/home/peter/anaconda3/bin&quot;</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/home/peter/anaconda3/bin/jupyterhub -f /home/peter/jupyterhub_config.py</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<p>Save and exit with [Ctrl-c] + [y]. Now we need to reload the system daemon and run <strong>jupyterhub</strong> as a system process using the command: <code>sudo systemctl &lt;start|stop|status&gt; jupyterhub</code></p>
<div class="highlight"><pre><span></span>$ sudo systemctl daemon-reload
$ sudo systemctl start jupyterhub
</pre></div>


<p>We can see if <strong>jupyterhub</strong> is running with:</p>
<div class="highlight"><pre><span></span>$ sudo systemctl status jupyterhub

 Loaded: loaded <span class="o">(</span>/etc/systemd/system/jupyterhub.service<span class="p">;</span> 
 Active: active <span class="o">(</span>running<span class="o">)</span>
</pre></div>


<p><br></p>
<h3 id="2-test-local-oauth">2. Test local OAuth</h3>
<p>Now we can go to the server and log in as our non-root user, and log in as the other user we created <code>kendra</code>.</p>
<p>A couple times I thought that <strong>jupyterhub</strong> was running after using <code>systemctl start jupyterhub</code>, but the hub wasn't working when I went to the hub's web address. It turned out that <strong>jupyterhub</strong> wasn't running when I keyed in <code>systemctl status jupyterhub</code>. Most times looking for an error and tracking down the the error worked, but one time it seemed to be a problem with the http-configurable-proxy. The following command will shut down the proxy if you get stuck like I did (insert the number corresponding to the configurable-http-proxy process after the <code>kill</code> command):</p>
<div class="highlight"><pre><span></span>$ ps aux <span class="p">|</span> grep configurable-http-proxy
$ <span class="nb">kill</span> <span class="c1">#### </span>
</pre></div>


<p><br></p>
<h3 id="3-acquire-github-oauth-credentials">3. Acquire Github OAuth credentials</h3>
<p>A problem now is that if we go to the admin page on jupyter hub, we can't add new users. The users have to be added to the server using PuTTY first and then can be added to <strong>jupyterhub</strong> with the admin panel. This is OK for a small team or a couple users, but for a college class, creating a new user on the server for each student, then emailing out passwords... Ah! what a mess. So we need to give <strong>jupyterhub</strong> the authority to create new users from the admin panel and we need a way to have users login with a user name and password they already have.</p>
<p>One of the ways students could log into Jupyter Hub is using their github credentials. This would require each student to have a github account. A github account for each student might be worth it to give students exposure to git and github as a tools. So let's give the github authenticator a whirl. The github authenticator is also pretty well documented for Jupyter Hub, so it's good authenticator to try first.</p>
<p>To use the github authenticator, we need to install <strong>oauthenticator</strong>. I couldn't find oauthenticator on conda-forge. If it's on conda-forge, I would install it from there rather than PyPI. But for this one, I used <strong>pip</strong>.</p>
<div class="highlight"><pre><span></span>$ pip install conda install oauthenticator
</pre></div>


<p>Now we need to log into github and create an OAuth App and copy the Client ID and Client Secret. The short version is:</p>
<p>github profile &rarr; settings &rarr; Developer Settings &rarr; OAuth Apps &rarr; Register a new application</p>
<p><img alt="github settings" src="/posts/jupyterhub/github_settings.png"></p>
<p><img alt="github developer settings" src="/posts/jupyterhub/github_developer_settings.png"></p>
<p><img alt="github register new applicaiton" src="/posts/jupyterhub/github_register_new_application.png"></p>
<p>Set the <strong>Homepage URL</strong> as:</p>
<div class="highlight"><pre><span></span>https://notebooks.yourdomain.com/
</pre></div>


<p>Set the <strong>Authorization call-back URL</strong> as:</p>
<div class="highlight"><pre><span></span>https://notebooks.yourdomain.com/hub/oauth_callback
</pre></div>


<p><img alt="github register new app" src="/posts/jupyterhub/github_register_oauth_app.png"></p>
<p>in the App Settings page, we need to copy two settings:</p>
<ul>
<li>Client ID</li>
<li>Client Secret</li>
</ul>
<p><img alt="github client id and secret" src="/posts/jupyterhub/github_client_id_and_secret.png"></p>
<p>These two long strings will need to be pasted into the jupyterhub_config.py file. </p>
<p><br></p>
<h3 id="4-modify-jupyterhub_configpy-to-use-github-oauth">4. Modify jupyterhub_config.py to use github OAuth</h3>
<p>Now we'll edit the <code>jupyterhub_config.py</code> file to include a couple additional lines. Note in the configuration below, <code>#c.Authenticator.whitelist</code> is commented out. We want to see if a github user can log onto the server (which will automatically create a new user and spawn a jupyter notebook server) and run notebooks. Once we know the server is working, we can uncomment the white list and only allow in specific github usernames. Note <code>c.LocalGitHubOAuthenticator.client_id</code> and <code>c.LocalGitHubOAuthenticator.client_secret</code> are the long strings from our github OAuth App.</p>
<div class="highlight"><pre><span></span><span class="c1">#jupyterhub_config.py</span>

<span class="kn">from</span> <span class="nn">oauthenticator.github</span> <span class="kn">import</span> <span class="n">LocalGitHubOAuthenticator</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">authenticator_class</span> <span class="o">=</span> <span class="n">LocalGitHubOAuthenticator</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGitHubOAuthenticator</span><span class="o">.</span><span class="n">oauth_callback_url</span> <span class="o">=</span> <span class="s1">&#39;https://notebooks.problemsolvingwithpython.com/hub/oauth_callback&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGitHubOAuthenticator</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxxxxxxxxxxxx&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGitHubOAuthenticator</span><span class="o">.</span><span class="n">client_secret</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&#39;</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGitHubOAuthenticator</span><span class="o">.</span><span class="n">create_system_users</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c1">#c.Authenticator.whitelist = {&#39;peter&#39;,&#39;kendra&#39;}</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">admin_users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;peter&#39;</span><span class="p">}</span>
</pre></div>


<p>Restart <strong>jupyterhub with</strong></p>
<div class="highlight"><pre><span></span>$ sudo systemctl stop jupyterhub
$ sudo systemctl start jupyterhub
$ sudo systemctl status jupyterhub
</pre></div>


<p>Browse over to the hub's URL and we should be able to log in with a github username and password. </p>
<p><img alt="Sign in with GitHub" src="/posts/jupyterhub/sign_in_with_github.PNG"></p>
<p><br></p>
<h3 id="4-google-authenticator">4. Google Authenticator</h3>
<p>Now that the github authenticator works, we are going to get into the weeds of getting the google authenticator to work. Why google authenticator instead of github? Our college uses the gmail suite for both staff and students. When students log onto their college email, they are logging into gmail. Students can use google calendar and google drive with their college email account as well. So it is probably best that students log into juypter hub using the same google login that they use to access their college email, google drive and calendar. </p>
<p>First up we need to set up a google OAuth instance. I did this using my personal gmail account rather than my college gmail account. Some parts of google suite are not available in my college profile like youtube and developer tabs. </p>
<p>To obtain the google OAuth credentials, we need to log into the google API console <a href="https://console.developers.google.com/">https://console.developers.google.com/</a> and select [Credentials] on the lefthand menu.</p>
<p><img alt="google oauth credentials" src="/posts/jupyterhub/google_oauth_credentials.png"></p>
<p>Next we'll create a new OAuth credential under [Credentials] &rarr; [Create Credentials] &rarr; [OAuth client ID]:</p>
<p><img alt="google create credentials" src="/posts/jupyterhub/google_oauth_create_credentials.png"></p>
<p>To create a set of google OAuth credentials you will need to input:</p>
<ul>
<li>Authorized JavaScript origins: https://notebooks.yourdomain.com</li>
<li>callback url: https://notebooks.yourdomain.com/hub/oauth_callback</li>
</ul>
<p><img alt="google js origins and callback url" src="/posts/jupyterhub/google_oauth_javascript_origins_redirect_uri.png"></p>
<p>After creating a new set of google OAuth credentials, note the:</p>
<ul>
<li>client ID</li>
<li>client secret</li>
</ul>
<p><img alt="google client ID and secret" src="/posts/jupyterhub/google_oauth_client_id_and_secret.png"></p>
<p>These two longs strings will be included in our revised <strong>jupyterhub</strong> configuration.</p>
<p>Once we get our google OAuth credentials, we need to edit <code>jupyterhub_conf.py</code>. Note the google OAuth credentials need to replace <code>'xxxxxxxxxxxxxxx'</code> </p>
<div class="highlight"><pre><span></span><span class="c1">#jupyterhub_conf.py</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">c</span><span class="o">.</span><span class="n">Spawner</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;/home/peter/anaconda3/bin/jupyterhub-singleuser&#39;</span>

<span class="c1"># For Google OAuth Authentication</span>
<span class="kn">from</span> <span class="nn">oauthenticator.google</span> <span class="kn">import</span> <span class="n">LocalGoogleOAuthenticator</span>
<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">authenticator_class</span> <span class="o">=</span> <span class="n">LocalGoogleOAuthenticator</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">create_system_users</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">hosted_domain</span> <span class="o">=</span> <span class="s1">&#39;yourcollege.edu&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">login_service</span> <span class="o">=</span> <span class="s1">&#39;Your College Name&#39;</span>

<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">oauth_callback_url</span> <span class="o">=</span> <span class="s1">&#39;https://notebooks.yourserver.com/hub/oauth_callback&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">oauth_client_id</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxxxxxxxxxxx&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LocalGoogleOAuthenticator</span><span class="o">.</span><span class="n">oauth_client_secret</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxxxxxxxxx&quot;</span>
<span class="c1">#c.JupyterHub.cookie_secret_file = &#39;/srv/jupyterhub/jupyterhub_cookie_secret&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">add_user_cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;adduser&#39;</span><span class="p">,</span> <span class="s1">&#39;-q&#39;</span><span class="p">,</span> <span class="s1">&#39;--gecos&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;--disabled-password&#39;</span><span class="p">,</span> <span class="s1">&#39;--force-badname&#39;</span><span class="p">]</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">whitelist</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;studnet.username&#39;</span><span class="p">,</span><span class="s1">&#39;faculty.username&#39;</span><span class="p">}</span>
<span class="n">c</span><span class="o">.</span><span class="n">Authenticator</span><span class="o">.</span><span class="n">admin_users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;faculty.username&#39;</span><span class="p">}</span>
</pre></div>


<p>This little line:</p>
<div class="highlight"><pre><span></span>c.Authenticator.add_user_cmd = [&#39;adduser&#39;, &#39;-q&#39;, &#39;--gecos&#39;, &#39;&quot;&quot;&#39;, &#39;--disabled-password&#39;, &#39;--force-badname&#39;]
</pre></div>


<p>was a real gottacha. Our college email addresses are in the form:</p>
<p>firstname.lastname@college.edu </p>
<p>So <strong>jupyterhub</strong> was trying to create users with dots <code>.</code> in their usernames. This doesn't work in linux. I tried creating a new user with a dot in their username and it asked me to use the <code>--force-badname</code> flag. So that is what we'll add to the <code>c.Authenticator.add_user_cmd</code> list. Otherwise the users will be able to authenticate, buy they won't get a new account on the server and they won't be able to run notebooks.</p>
<p>Restart <strong>jupyterhub</strong> and browse to the web address attached to the server.</p>
<div class="highlight"><pre><span></span>$ sudo systemctl stop jupyterhub
$ sudo systemctl start jupyterhub
$ sudo systemctl status jupyterhub
<span class="c1"># [Ctrl + c] to exit</span>
</pre></div>


<p>The login window should look something like:</p>
<p><img alt="Sign in with google" src="/posts/jupyterhub/sign_in_with_google.PNG"></p>
<p>We can log in with our google user name and password (college username and password). Pretty sweet.</p>
<p><br></p>
<h3 id="summary">Summary</h3>
<p>In this post, we set <strong>jupyterhub</strong> to run as a system service in the background which allowed us to work on the server and run <strong>jupyterhub</strong> at the same time. Then we added a github authentication system so that users could log into our Jupyter Hub server using their github usernames and passwords. Then we modified the authentication system to use google user names and passwords even if the usernames contained a dot. </p>
<p><br></p>
<h3 id="next-steps">Next Steps</h3>
<p>Up next we will see if we can populate each new user's working directory tree with a couple of notebooks that will be the assignments for the quarter. We'll see if we can pull these down from github so that the assignments can be edited by instructors and viewed by the students before the quarter starts.</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="./assignments-dir-and-custom-login-page-to-jupyterhub.html">Add a custom login page and assignments directory for each user on a Jupyter Hub server</a></li>
        <li><a href="./add-ssl-and-domain-name-to-jupyterhub.html">Adding SSL and a domain name to Jupyter Hub</a></li>
        <li><a href="./installing-jupyter-hub.html">Installing Jupyterhub</a></li>
        <li><a href="./new-digital-ocean-droplet.html">Creating a new Digital Ocean Droplet</a></li>
        <li><a href="./ssh-keys-with-putty.html">Create an SSH Key with PuTTYgen</a></li>
    </ul>
</section>
<section class="well" id="related-posts">
    <h4>Article 6 of the Jupyter Hub series</h4>
       <h5>Previous articles</h5>
       <ul>
           <li><a href="./why-jupyter-hub.html">Why Jupyter Hub?</a></li>
           <li><a href="./ssh-keys-with-putty.html">Create an SSH Key with PuTTYgen</a></li>
           <li><a href="./new-digital-ocean-droplet.html">Creating a new Digital Ocean Droplet</a></li>
           <li><a href="./installing-jupyter-hub.html">Installing Jupyterhub</a></li>
           <li><a href="./add-ssl-and-domain-name-to-jupyterhub.html">Adding SSL and a domain name to Jupyter Hub</a></li>
       </ul>
       <h5>Next articles</h5>
       <ul>
           <li><a href="./assignments-dir-and-custom-login-page-to-jupyterhub.html">Add a custom login page and assignments directory for each user on a Jupyter Hub server</a></li>
       </ul>
</section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="./extra/gear-wrench-icon-512-278694.png"/>
        </p>
    <p>
      <strong>About Peter Kazarinoff</strong><br/>
        I teach engineering at a community college in the Pacific Northwest. I am interested in programming and how to help students. Here I mostly blog about Python, MATLAB and how programing can be incorporated into engineering education.
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./flask-app-on-digital-ocean.html">Building a single page Flask App on Digital Ocean</a></li>
    <li class="list-group-item"><a href="./micropython-upload-code.html">Upload Micropython Code to an Adafruit Feather Huzzah ESP8266</a></li>
    <li class="list-group-item"><a href="./micropython-wifi.html">Using Micropython to connect an Adafruit Feather Huzzah ESP8266 to WiFi</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="./"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group list-inline tagcloud" id="tags">
    <li class="list-group-item tag-3">
      <a href="./tag/blog.html">blog</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/engineering.html">engineering</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/esp8266.html">esp8266</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="./tag/jupyter.html">jupyter</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/jupyter-hub.html">jupyter hub</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/jupyter-notebooks.html">jupyter notebooks</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/microcontroller.html">microcontroller</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/micropython.html">micropython</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/pelican.html">pelican</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="./tag/python.html">python</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->

<!-- Sidebar/Series -->
<li class="list-group-item">
  <h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Series</span></h4>
  <ul class="list-group">
    <li class="list-group-item">
      <h5></i>Previous article</h5>
      <a href="./add-ssl-and-domain-name-to-jupyterhub.html">Adding SSL and a domain name to Jupyter Hub</a>
    </li>
    <li class="list-group-item">
      <h5>Next article</h5>
      <a href="./assignments-dir-and-custom-login-page-to-jupyterhub.html">Add a custom login page and assignments directory for each user on a Jupyter Hub server</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Series -->


<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/professorkazarinoff">@professorkazarinoff</a> on GitHub
</li>
<!-- End Sidebar/Github -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Peter Kazarinoff
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>

    <script src="./static/js/custom.js"></script>


<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = './theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  github.showRepos({
    user: 'professorkazarinoff',
    count: 5,
    skip_forks: true,
    target: '#gh_repos'
  });
});
</script>
<script src="./theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-116330557-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>
</body>
</html>