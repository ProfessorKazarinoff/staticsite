<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Writing Tests in Scientific Code - Python for Undergraduate Engineers</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




<style type="text/css">

    /*some stuff for output/input prompts*/
    div.cell{border:1px solid transparent;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}div.cell.selected{border-radius:4px;border:thin #ababab solid}
    div.cell.edit_mode{border-radius:4px;border:thin #008000 solid}
    div.cell{width:100%;padding:5px 5px 5px 0;margin:0;outline:none}
    div.prompt{min-width:11ex;padding:.4em;margin:0;font-family:monospace;text-align:right;line-height:1.21429em}
    @media (max-width:480px){div.prompt{text-align:left}}div.inner_cell{display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;flex:1}
    div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;line-height:1.21429em}
    div.prompt:empty{padding-top:0;padding-bottom:0}
    div.input{page-break-inside:avoid;display:-webkit-box;-webkit-box-orient:horizontal;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:horizontal;-moz-box-align:stretch;display:box;box-orient:horizontal;box-align:stretch;}
    div.inner_cell{width:90%;}
    div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;}
    div.input_prompt{color:navy;border-top:1px solid transparent;}
    div.output_wrapper{margin-top:5px;position:relative;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
    div.output_scroll{height:24em;width:100%;overflow:auto;border-radius:4px;-webkit-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);-moz-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);}
    div.output_collapsed{margin:0px;padding:0px;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
    div.out_prompt_overlay{height:100%;padding:0px 0.4em;position:absolute;border-radius:4px;}
    div.out_prompt_overlay:hover{-webkit-box-shadow:inset 0 0 1px #000000;-moz-box-shadow:inset 0 0 1px #000000;box-shadow:inset 0 0 1px #000000;background:rgba(240, 240, 240, 0.5);}
    div.output_prompt{color:darkred;}
    
    a.anchor-link:link{text-decoration:none;padding:0px 20px;visibility:hidden;}
    h1:hover .anchor-link,h2:hover .anchor-link,h3:hover .anchor-link,h4:hover .anchor-link,h5:hover .anchor-link,h6:hover .anchor-link{visibility:visible;}
    /* end stuff for output/input prompts*/
    
    
    .highlight-ipynb .hll { background-color: #ffffcc }
    .highlight-ipynb  { background: #f8f8f8; }
    .highlight-ipynb .c { color: #408080; font-style: italic } /* Comment */
    .highlight-ipynb .err { border: 1px solid #FF0000 } /* Error */
    .highlight-ipynb .k { color: #008000; font-weight: bold } /* Keyword */
    .highlight-ipynb .o { color: #666666 } /* Operator */
    .highlight-ipynb .cm { color: #408080; font-style: italic } /* Comment.Multiline */
    .highlight-ipynb .cp { color: #BC7A00 } /* Comment.Preproc */
    .highlight-ipynb .c1 { color: #408080; font-style: italic } /* Comment.Single */
    .highlight-ipynb .cs { color: #408080; font-style: italic } /* Comment.Special */
    .highlight-ipynb .gd { color: #A00000 } /* Generic.Deleted */
    .highlight-ipynb .ge { font-style: italic } /* Generic.Emph */
    .highlight-ipynb .gr { color: #FF0000 } /* Generic.Error */
    .highlight-ipynb .gh { color: #000080; font-weight: bold } /* Generic.Heading */
    .highlight-ipynb .gi { color: #00A000 } /* Generic.Inserted */
    .highlight-ipynb .go { color: #888888 } /* Generic.Output */
    .highlight-ipynb .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
    .highlight-ipynb .gs { font-weight: bold } /* Generic.Strong */
    .highlight-ipynb .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
    .highlight-ipynb .gt { color: #0044DD } /* Generic.Traceback */
    .highlight-ipynb .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
    .highlight-ipynb .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
    .highlight-ipynb .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
    .highlight-ipynb .kp { color: #008000 } /* Keyword.Pseudo */
    .highlight-ipynb .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
    .highlight-ipynb .kt { color: #B00040 } /* Keyword.Type */
    .highlight-ipynb .m { color: #666666 } /* Literal.Number */
    .highlight-ipynb .s { color: #BA2121 } /* Literal.String */
    .highlight-ipynb .na { color: #7D9029 } /* Name.Attribute */
    .highlight-ipynb .nb { color: #008000 } /* Name.Builtin */
    .highlight-ipynb .nc { color: #0000FF; font-weight: bold } /* Name.Class */
    .highlight-ipynb .no { color: #880000 } /* Name.Constant */
    .highlight-ipynb .nd { color: #AA22FF } /* Name.Decorator */
    .highlight-ipynb .ni { color: #999999; font-weight: bold } /* Name.Entity */
    .highlight-ipynb .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
    .highlight-ipynb .nf { color: #0000FF } /* Name.Function */
    .highlight-ipynb .nl { color: #A0A000 } /* Name.Label */
    .highlight-ipynb .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
    .highlight-ipynb .nt { color: #008000; font-weight: bold } /* Name.Tag */
    .highlight-ipynb .nv { color: #19177C } /* Name.Variable */
    .highlight-ipynb .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
    .highlight-ipynb .w { color: #bbbbbb } /* Text.Whitespace */
    .highlight-ipynb .mf { color: #666666 } /* Literal.Number.Float */
    .highlight-ipynb .mh { color: #666666 } /* Literal.Number.Hex */
    .highlight-ipynb .mi { color: #666666 } /* Literal.Number.Integer */
    .highlight-ipynb .mo { color: #666666 } /* Literal.Number.Oct */
    .highlight-ipynb .sb { color: #BA2121 } /* Literal.String.Backtick */
    .highlight-ipynb .sc { color: #BA2121 } /* Literal.String.Char */
    .highlight-ipynb .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
    .highlight-ipynb .s2 { color: #BA2121 } /* Literal.String.Double */
    .highlight-ipynb .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
    .highlight-ipynb .sh { color: #BA2121 } /* Literal.String.Heredoc */
    .highlight-ipynb .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
    .highlight-ipynb .sx { color: #008000 } /* Literal.String.Other */
    .highlight-ipynb .sr { color: #BB6688 } /* Literal.String.Regex */
    .highlight-ipynb .s1 { color: #BA2121 } /* Literal.String.Single */
    .highlight-ipynb .ss { color: #19177C } /* Literal.String.Symbol */
    .highlight-ipynb .bp { color: #008000 } /* Name.Builtin.Pseudo */
    .highlight-ipynb .vc { color: #19177C } /* Name.Variable.Class */
    .highlight-ipynb .vg { color: #19177C } /* Name.Variable.Global */
    .highlight-ipynb .vi { color: #19177C } /* Name.Variable.Instance */
    .highlight-ipynb .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>
    
    <style type="text/css">
    /* Overrides of notebook CSS for static HTML export */
    div.entry-content {
      overflow: visible;
      padding: 8px;
    }
    .input_area {
      padding: 0.2em;
    }
    
    a.heading-anchor {
     white-space: normal;
    }
    
    .rendered_html
    code {
     font-size: .8em;
    }
    
    pre.ipynb {
      color: black;
      background: #f7f7f7;
      border: none;
      box-shadow: none;
      margin-bottom: 0;
      padding: 0;
      margin: 0px;
      font-size: 13px;
    }
    
    /* remove the prompt div from text cells */
    div.text_cell .prompt {
        display: none;
    }
    
    /* remove horizontal padding from text cells, */
    /* so it aligns with outer body text */
    div.text_cell_render {
        padding: 0.5em 0em;
    }
    
    img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}
    
    div.collapseheader {
        width=100%;
        padding: 2px;
        cursor: pointer;
        font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
    }
    
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
    <script type="text/javascript">
    init_mathjax = function() {
        if (window.MathJax) {
            // MathJax loaded
            MathJax.Hub.Config({
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
                },
                displayAlign: 'center', // Change this to 'center' to center equations.
                "HTML-CSS": {
                    styles: {'.MathJax_Display': {"margin": 0}}
                }
            });
            MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    
    <link href="../extra/favicon.ico" rel="icon">

<link rel="canonical" href="../drafts/writing-tests-in-scientific-code.html">

        <meta name="author" content="Peter D. Kazarinoff" />
        <meta name="keywords" content="engineering,testing" />
        <meta name="description" content="In a previous blog post, I wrote about how to incorporate a few software design principals into the code written by scientists. This post is a follow up on one specific software design principal that can be used by scientists: testing Below are some practical ideas about how to incorporate …" />

        <meta property="og:site_name" content="Python for Undergraduate Engineers" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Writing Tests in Scientific Code"/>
        <meta property="og:url" content="../drafts/writing-tests-in-scientific-code.html"/>
        <meta property="og:description" content="In a previous blog post, I wrote about how to incorporate a few software design principals into the code written by scientists. This post is a follow up on one specific software design principal that can be used by scientists: testing Below are some practical ideas about how to incorporate …"/>
        <meta property="article:published_time" content="2021-02-19" />
            <meta property="article:section" content="Python" />
            <meta property="article:tag" content="engineering" />
            <meta property="article:tag" content="testing" />
            <meta property="article:author" content="Peter D. Kazarinoff" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="../theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="../theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="../theme/css/pygments/native.css" rel="stylesheet">
    <link href="../theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="../theme/css/style.css" type="text/css"/>
        <link href="../static/css/custom.css" rel="stylesheet">



</head>
<body>

<!-- .navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="../" class="navbar-brand">
Python for Undergraduate Engineers            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="../pages/about.html">
                             About
                          </a></li>
                         <li><a href="../pages/book.html">
                             Book
                          </a></li>
                         <li><a href="../pages/now.html">
                             Now
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">

<!-- .navbar-search -->
<li>
    <span>
        <form class="navbar-search" action="/search.html">
            <input type="text" name="q" id="tipue_search_input">
        </form>
    </span>
</li>
<!-- /.navbar-search -->              <li><a href="../archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-9">
            <ol class="breadcrumb">
                <li><a href=".." title="Python for Undergraduate Engineers"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="../category/python.html" title="Python">Python</a></li>
                <li class="active">Writing Tests in Scientific Code</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="../drafts/writing-tests-in-scientific-code.html"
                       rel="bookmark"
                       title="Permalink to Writing Tests in Scientific Code">
                        Writing Tests in Scientific Code
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2021-02-19T08:11:00-08:00"> Fri 19 February 2021</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="../tag/engineering.html">engineering</a>
        /
	<a href="../tag/testing.html">testing</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p><img alt="science lab" src="../posts/testing_science_code/images/lab.jpg"></p>
<p>In a <a href="../thoughts-on-software-design-in-scientific-code.html">previous blog post</a>, I wrote about how to incorporate a few software design principals into the code written by scientists. This post is a follow up on one specific software design principal that can be used by scientists: <strong>testing</strong></p>
<p>Below are some practical ideas about how to incorporate software testing in science data analysis. Keep in mind the steps and tests below don't correspond to every piece of scientific code. My ideas are not designed to revoultionize the ways scientists write code, or fix repoducibility problems in published scientific research, or be a strict TDD (Test-Driven Development) framework for scientific code. The ideas below are some things I came up with that I wanted to share and my hope is that it is helpful and starts a few conversations.</p>
<p><strong>OK - with that disclaimer out of the way, let's get started.</strong></p>
<h3 id="a-sample-notebook">A sample notebook</h3>
<p>Below is a sample Jupyter notebook with Python code that reads an excel file of data, plots the data, and then outputs two calculated values. In this case, the data is from a mechanical test frame (a piece of equipment that tests the strength of materials), but the same testing ideas could be applied to a script that analyzes data in another subject area.</p>
<p>Very often scientific code includes a couple of common steps:</p>
<ul>
<li>Read in data</li>
<li>Clean or reorganize the data</li>
<li>Run calculations on the data</li>
<li>Create a figure or plot</li>
</ul>
<p>The code below is one long script. In the rest of this post, we are going work on adding tests to this script.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="n">raw_data_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/raw_data.csv&#39;</span><span class="p">)</span>
<span class="n">raw_data_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">raw_data_df</span><span class="p">)</span>
<span class="n">cleaned_data_array</span> <span class="o">=</span> <span class="n">raw_data_array</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span>

<span class="n">d</span> <span class="o">=</span> <span class="mf">0.506</span>
<span class="n">A0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">cleaned_data_array</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
<span class="n">stress</span> <span class="o">=</span> <span class="n">F</span><span class="o">/</span><span class="n">A0</span>
<span class="n">strain</span> <span class="o">=</span> <span class="n">cleaned_data_array</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span>
<span class="n">ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">stress</span><span class="p">)</span>
<span class="n">te</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">strain</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">strain</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Tensile Strength={ts}&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Total Extension={te}&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">strain</span><span class="p">,</span><span class="n">stress</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Strain (mm/mm)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Stress (MPa)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>


<p>In the top section of code, a few packages are imported. The next section of code reads in data from a .csv file, converts it to an array and cleans it up. The next section of code includes some analysis to calculate two values. The final section of code creates a plot.</p>
<p>So how can we possibly write software tests for this script?</p>
<p><img alt="cup cakes" src="../posts/testing_science_code/images/cupcakes.jpg"></p>
<h2 id="testing-in-scientific-software-is-about-reproducibiliy">Testing in Scientific Software is about Reproducibiliy</h2>
<p>The first idea isn't code or a specific test, it's the idea that <strong>testing scientists code is about ensuring reproducibility</strong>. It's my understanding that testing software in general (not scientist's code) is about ensuring the system runs error-free and accomplishes what the programmer intends. In scientist's code, my argument is that testing should be more about making sure the code is reproducible by other rearchers (or more likely useable to the scientist 6 months later or usable by a new grad student), than ensuring the code runs error-free or produces the desired result. <em>All scientists what their research to be repoducible, right?</em></p>
<p><img alt="code" src="../posts/testing_science_code/images/python_code.png"></p>
<h2 id="use-a-py-file-instead-of-a-jupyter-notebook">Use a .py-file instead of a Jupyter notebook</h2>
<p>The second idea is to write scientific code in a <strong>.py-file</strong> instead of writing code in a Jupyter notebook. Now, I love Jupyter notebooks. Jupyter notebooks are great for data exploration, plot creation and presentation. But... after the initial exploration, move code from a Jupyter notebook into a .py-file. Within the Jupyter notebook interface, you can select File &rarr; Download As and select .py as the file type. </p>
<p><img alt="Download As in Jupyter notebook" src="../posts/testing_science_code/images/jupyter_notebook_download_as.jpg"></p>
<p>After the Jupyter notebook is saved as a .py-file, run the .py-file from the command line. See if the same output is produced by the .py-file and the Jupyter notebook. Jupyter notebook cells can be run in any order. The execution order of a Jupyter notebook sometimes effects the output of the code. When the code is in a .py-file, the execution order of the lines of Python code are set by your programming logic. So idealy, each time your run the .py-file, the output is the same. In the next section, we'll deal with Python versions and dependancies.</p>
<p><img alt="pack mule" src="../posts/testing_science_code/images/pack_mule.jpg"></p>
<h2 id="define-package-dependancies-and-python-version">Define Package Dependancies and Python Version</h2>
<p>After the scientific script is saved as a .py-file, the next step is to define the Python version and package dependancies needed to run the script. This can be accomplished by creating a <code>requirements.txt</code> file that contains the specific versions of the packages your script is run with. These packages just need to be the high-level dependancies that are imported by your script. The contents of a sample <code>requirements.txt</code> file are below. Note that <strong>pytest</strong> is also included as a dependancy. We are going to use pytests a little later.</p>
<div class="highlight"><pre><span></span>matplotib==3.3.2
numpy==1.19.2
pandas==1.1.3
pytest==6.1.1
</pre></div>


<p>If you don't know what version of matplotlib you are using, open the Python REPL and type:</p>
<div class="highlight"><pre><span></span>&gt;&gt;&gt; import matplotlib
&gt;&gt;&gt; matplotlib.__version__
3.3.2
</pre></div>


<p>The <code>.__version__</code> attribute is commonly defined for popular Python packages. </p>
<p>In addition to the packages used by your script, you can also define which version of Python you are using. The Python version can be stored in a file called <code>runtime.txt</code>. The contents of an example <code>runtime.txt</code> file are below:</p>
<div class="highlight"><pre><span></span>python-3.8.3
</pre></div>


<p>The python version you are using is shown when you enter the Python REPL. In a termial type <code>python</code> and the version is printed out above the REPL prompt.</p>
<div class="highlight"><pre><span></span>&gt; python
Python 3.8.3 (default, Jul  2 2020, 17:30:36) [MSC v.1916 64 bit (AMD64)] :: Anaconda, Inc. on win32
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt;
</pre></div>


<p>At this point, we have now converted an originol Jupyter notebook into a Python script. We have also included a <code>requirements.txt</code> file and a <code>runtime.txt</code> file. The directory structure of our growing project is shown below.</p>
<div class="highlight"><pre><span></span>project/
    analysis.ipynb
    analysis.py
    requirements.txt
    runtime.txt
    data/
        raw_data.csv
    output/
        plot.png
</pre></div>


<h2 id="test-the-dependancy-package-versions-and-the-python-version">Test the Dependancy Package Versions and the Python Version</h2>
<p>Now that we defined our package versions and Python runtime version, we can write tests to confirm these are the same versions that are used when our script is run. If another researcher wants to run our script, they can confirm through our tests that they are using the same dependancy versions. Create a new directory called <code>tests</code> and inside create a new file called <code>test_dependancies.py</code>. In addition, create a blank <code>__init__.py</code> file along side the <code>test_dependancies.py</code> file. This defines the <code>tests/</code> directory as a package.</p>
<p>The directory structure of our project should now look like:</p>
<div class="highlight"><pre><span></span>project/
    analysis.ipynb
    analysis.py
    requirements.txt
    runtime.txt
    data/
        raw_data.csv
    output/
        plot.png
    tests/
        __init__.py
        test_dependancies.py
</pre></div>


<p>Inside the <code>test_dependancies.py</code> file, we can write tests that confirm the versions of the packages we say are necessary in our <code>requirements.txt</code> file. Examples of these tests are below.</p>
<div class="highlight"><pre><span></span><span class="c1"># test_dependancies.py</span>

<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>

<span class="k">def</span> <span class="nf">test_numpy_version</span><span class="p">():</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;1.18.5&quot;</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span>
    <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>


<span class="k">def</span> <span class="nf">test_pandas_version</span><span class="p">():</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;1.0.5&quot;</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">__version__</span>
    <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>


<span class="k">def</span> <span class="nf">test_matplotlib_version</span><span class="p">():</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;3.2.2&quot;</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">__version__</span>
    <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>


<p>We can run these tests from the command line as long as pytest is installed. The command below runs the tests we defined in <code>test_dependancies.py</code></p>
<div class="highlight"><pre><span></span>&gt; python -m pytest tests/test_dependancies.py
</pre></div>


<p>The output should be something like below:</p>
<div class="highlight"><pre><span></span># pytest output
</pre></div>


<p>We can also write a test for the version of Python we're using in <code>test_dependancies.py</code>. The test below ensure Python verison 3.8.3 is used. Make sure to import the <code>platform</code> module from the standard library or the test won't work.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">platorm</span>

<span class="k">def</span> <span class="nf">test_python_version</span><span class="p">():</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;3.8.3&quot;</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_version</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>


<p>Now all four tests can be run on the command line with pytest:</p>
<div class="highlight"><pre><span></span>&gt; python -m pytest tests/test_dependancies.py
</pre></div>


<p>The output should look something like below:</p>
<div class="highlight"><pre><span></span>pytest output
</pre></div>


<p>One more test we can write is for what character encoding is being used. If you are using a regular computer, this character encodeing should be utf-8. Make sure to add the <code>sys</code> module import at the top of the <code>test_dependancies.py</code> file.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_system_encoding</span><span class="p">():</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">actual</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>


<p>We can run all tests with pytest. They should all pass. If they don't, that means some trouble shooting. <em>Are you sure those are the package versions you are using?</em></p>
<p>Now that we've written tests to ensure the versions of Python and our dependancies are what we think they are, we can make sure our script doesn't modify the data.</p>
<h2 id="test-if-your-code-should-modifies-the-data">Test if your code should modifies the data</h2>
<p><img alt="holding hands" src="../posts/testing_science_code/images/ice.jpeg"></p>
<p>When your code runs, it should not modify, rename, rewrite or otherwise change the originol data. If that happens as a result of your script, take it out. </p>
<div class="highlight"><pre><span></span><span class="c1"># pytest code that shows data isn&#39;t modified.</span>
</pre></div>


<p>We want to start testing the script <code>analysis.py</code> itself. But before we can test the script, we need to break the script up into functions.</p>
<h2 id="break-the-script-up-into-functions">Break the script up into functions</h2>
<p><img alt="holding hands" src="../posts/testing_science_code/images/kids-holding-hands.jpg"></p>
<p>Next, we are going to break the script <code>analysis.py</code> up into functions. If you don't know where to start, use the four bullet points below to help guide where to break up the one long script into 3 or 4 pieces. </p>
<ul>
<li>Read in data</li>
<li>Clean or reorganize the data</li>
<li>Run calculations on the data</li>
<li>Create a figure or plot</li>
</ul>
<p>Don't worry if all that happens is that you have four sections, each section is a function and each function has no inputs and no outputs. </p>
<p>```python</p>
<h1 id="analysispy">analysis.py</h1>
<p>import numpy as np
import pandas as pd
import matplotlib.pyplot as plt</p>
<p>def import_data():
    raw_data_df = pd.read_csv('data/raw_data.csv')
    raw_data_array = np.array(raw_data_df)
    return raw_np_array</p>
<p>def clean_data(raw_np_array):
    cleaned_data_array = raw_data_array[1:,:]
    return cleaned_data_array</p>
<p>def get_stress_and_strain(cleaned_data_array):
    d = 0.506
    A0 = np.pi * (d / 2) ** 2
    F = cleaned_data_array[:, 4]
    stress = F / A0
    strain = cleaned_data_array[:, 5] * 0.01
    return stress, strain</p>
<p>def get_tensile_strength(stress, strain):
    return np.max(stress).round(3)</p>
<p>def get_total_extension(stress, strain):
    return np.max(strain) - np.min(strain)</p>
<p>def plot(x,y):
    fig, ax = plt.subplots()
    ax.plot(x, y)
    ax.set_title(title)
    ax.set_xlabel("Strain (mm/mm)")
    ax.set_ylabel("Stress (MPa)")
    plt.show()</p>
<div class="highlight"><pre><span></span><span class="k">End</span> <span class="nv">the</span> <span class="nv">script</span> <span class="nv">by</span> <span class="nv">defining</span> <span class="nv">a</span> ```<span class="nv">main</span><span class="ss">()</span>``` <span class="nv">function</span> <span class="nv">that</span> <span class="nv">calls</span> <span class="nv">the</span> <span class="nv">functions</span> <span class="nv">defined</span> <span class="nv">above</span> <span class="nv">in</span> <span class="nv">the</span> <span class="nv">correct</span> <span class="nv">order</span>. <span class="k">Then</span> <span class="k">call</span> <span class="nl">the</span> ```<span class="nv">main</span><span class="ss">()</span>``` <span class="nv">function</span> <span class="nv">with</span> <span class="nv">an</span> ```<span class="k">if</span> <span class="nv">__name__</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">__main__</span><span class="s2">&quot;</span>:``` <span class="nv">line</span>.

```<span class="nv">python</span>
<span class="nv">def</span> <span class="nv">main</span><span class="ss">()</span>:
    <span class="nv">raw_data_array</span> <span class="o">=</span> <span class="nv">import_data</span><span class="ss">()</span>
    <span class="nv">clean_data_array</span> <span class="o">=</span> <span class="nv">clean_data</span><span class="ss">(</span><span class="nv">raw_data_array</span><span class="ss">)</span>
    <span class="nv">stress</span>, <span class="nv">strain</span> <span class="o">=</span> <span class="nv">get_stress_and_strain</span><span class="ss">(</span><span class="nv">clean_data_array</span><span class="ss">)</span>
    <span class="nv">plot</span><span class="ss">(</span><span class="nv">strain</span>, <span class="nv">stress</span><span class="ss">)</span>
    <span class="nv">ts</span> <span class="o">=</span> <span class="nv">get_tensile_strength</span><span class="ss">(</span><span class="nv">stress</span>, <span class="nv">strain</span><span class="ss">)</span>
    <span class="nv">te</span> <span class="o">=</span> <span class="nv">get_total_extension</span><span class="ss">(</span><span class="nv">stress</span>, <span class="nv">strain</span><span class="ss">)</span>
    <span class="nv">print</span><span class="ss">(</span><span class="nv">f</span><span class="s2">&quot;</span><span class="s">Tensile Strength: {ts}, Total Extension: {te}</span><span class="s2">&quot;</span><span class="ss">)</span>


<span class="k">if</span> <span class="nv">__name__</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">__main__</span><span class="s2">&quot;</span>:
    <span class="nv">main</span><span class="ss">()</span>
</pre></div>


<p>Run the script from the command line. A plot should be produced and the output should be the same as when the script didn't contain any user-defined fuctions.</p>
<h2 id="consider-the-inputs-and-outputs-of-your-functions">Consider the inputs and outputs of your functions</h2>
<p><img alt="pipe" src="../posts/testing_science_code/images/pipe.jpeg"></p>
<p>Now that we removed all hard-coded file names and made sure that the data wasn't modified by the code, is it any clearer what the input and output of our functions should be? At the very least, modify your functions to return <code>True</code> at the end. For a function that produces a plot, assign the outputs as Matplotlib <code>fig</code> and <code>ax</code> objects.</p>
<div class="highlight"><pre><span></span><span class="c1"># code that have function inputs and outputs</span>
</pre></div>


<h2 id="test-each-function">Test each function</h2>
<p><img alt="pin wheel" src="../posts/testing_science_code/images/pin_wheel.jpg"></p>
<p>Now we are going to use <strong>pytest</strong> to test each function. Some of the functions can have expected input and output. Some functions may need an example file passed to them.</p>
<p>Before pytest can be used, pytest needs to be installed. You can install pytest using <strong>pip</strong>, Python's package manager</p>
<div class="highlight"><pre><span></span>$ pip install pytest
</pre></div>


<p>I set up my directory structure as shown below. The file which contains the tests start with the filename <code>test_ ...</code>.</p>
<div class="highlight"><pre><span></span>project_directory/
├── analysis.py
├── analysis_script.py
├── data
│   └── raw_data.csv
├── LICENSE
├── README.md
└── tests
    └── test_plot.py
</pre></div>


<h2 id="to-test-plots-test-the-fig-and-ax-objects">To test plots, test the fig and ax objects</h2>
<h2 id="test-the-main-function">Test the main() function</h2>
<h2 id="run-all-the-tests">Run all the tests</h2>
<h2 id="wrap-up">Wrap-Up</h2>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="../thoughts-on-software-design-in-scientific-code.html">Thoughts on Software Design in Scientific Code</a></li>
        <li><a href="../streamlit-app-with-bokeh.html">How to Build a Streamlit App in Python</a></li>
        <li><a href="../deflection-of-a-truncated-cone-with-python.html">Estimating the Deflection of a Truncated Cone using Python</a></li>
        <li><a href="../stress-strain-curve-with-python-and-matpotlib.html">Plotting a Stress Strain Curve with Python and Matplotlib</a></li>
        <li><a href="../plotting-bond-energy-with-matplotlib-and-python.html">Plotting Bond Energy vs. Distance with Python and Matplotlib</a></li>
    </ul>
</section>
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
    </div>
    <!-- AddThis Button END -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="../extra/gear-wrench-icon-512-278694.png"/>
        </p>
    <p>
      <strong>About Peter Kazarinoff</strong><br/>
        I teach engineering at a community college in the Pacific Northwest. I am interested in programming and how to help students. Here I mostly blog about Python, and how programing can be incorporated into engineering education.
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="../thoughts-on-software-design-in-scientific-code.html">Thoughts on Software Design in Scientific Code</a></li>
    <li class="list-group-item"><a href="../stream-S01-E01-jupyterhub-intro.html">My first Twitch Stream: S01-E01 JupyterHub Intro and Tools</a></li>
    <li class="list-group-item"><a href="../jupyterhub-deployment-on-running-in-production.html">Hear my story about deploying JupyterHub on the Running in Production Podcast</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="../"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group list-inline tagcloud" id="tags">
    <li class="list-group-item tag-2">
      <a href="../tag/engineering.html">engineering</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="../tag/esp8266.html">esp8266</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="../tag/flask.html">flask</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="../tag/jupyter.html">jupyter</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="../tag/jupyter-notebook.html">jupyter notebook</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="../tag/matplotlib.html">matplotlib</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="../tag/micropython.html">micropython</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="../tag/pelican.html">pelican</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="../tag/python.html">python</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="../tag/sensor.html">sensor</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->

<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/professorkazarinoff">@professorkazarinoff</a> on GitHub
</li>
<!-- End Sidebar/Github -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2021 Peter Kazarinoff
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="../theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="../theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="../theme/js/respond.min.js"></script>

    <script src="../static/js/custom.js"></script>


<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = '../theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  github.showRepos({
    user: 'professorkazarinoff',
    count: 5,
    skip_forks: true,
    target: '#gh_repos'
  });
});
</script>
<script src="../theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-116330557-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cdd8eb4e16bf94c"></script>
</body>
</html>