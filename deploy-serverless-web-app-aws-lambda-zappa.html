<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Deploy a Serverless Web App on AWS Lambda with Zappa - Python for Undergraduate Engineers</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




<style type="text/css">

    /*some stuff for output/input prompts*/
    div.cell{border:1px solid transparent;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}div.cell.selected{border-radius:4px;border:thin #ababab solid}
    div.cell.edit_mode{border-radius:4px;border:thin #008000 solid}
    div.cell{width:100%;padding:5px 5px 5px 0;margin:0;outline:none}
    div.prompt{min-width:11ex;padding:.4em;margin:0;font-family:monospace;text-align:right;line-height:1.21429em}
    @media (max-width:480px){div.prompt{text-align:left}}div.inner_cell{display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;flex:1}
    div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;line-height:1.21429em}
    div.prompt:empty{padding-top:0;padding-bottom:0}
    div.input{page-break-inside:avoid;display:-webkit-box;-webkit-box-orient:horizontal;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:horizontal;-moz-box-align:stretch;display:box;box-orient:horizontal;box-align:stretch;}
    div.inner_cell{width:90%;}
    div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;}
    div.input_prompt{color:navy;border-top:1px solid transparent;}
    div.output_wrapper{margin-top:5px;position:relative;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
    div.output_scroll{height:24em;width:100%;overflow:auto;border-radius:4px;-webkit-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);-moz-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);}
    div.output_collapsed{margin:0px;padding:0px;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
    div.out_prompt_overlay{height:100%;padding:0px 0.4em;position:absolute;border-radius:4px;}
    div.out_prompt_overlay:hover{-webkit-box-shadow:inset 0 0 1px #000000;-moz-box-shadow:inset 0 0 1px #000000;box-shadow:inset 0 0 1px #000000;background:rgba(240, 240, 240, 0.5);}
    div.output_prompt{color:darkred;}
    
    a.anchor-link:link{text-decoration:none;padding:0px 20px;visibility:hidden;}
    h1:hover .anchor-link,h2:hover .anchor-link,h3:hover .anchor-link,h4:hover .anchor-link,h5:hover .anchor-link,h6:hover .anchor-link{visibility:visible;}
    /* end stuff for output/input prompts*/
    
    
    .highlight-ipynb .hll { background-color: #ffffcc }
    .highlight-ipynb  { background: #f8f8f8; }
    .highlight-ipynb .c { color: #408080; font-style: italic } /* Comment */
    .highlight-ipynb .err { border: 1px solid #FF0000 } /* Error */
    .highlight-ipynb .k { color: #008000; font-weight: bold } /* Keyword */
    .highlight-ipynb .o { color: #666666 } /* Operator */
    .highlight-ipynb .cm { color: #408080; font-style: italic } /* Comment.Multiline */
    .highlight-ipynb .cp { color: #BC7A00 } /* Comment.Preproc */
    .highlight-ipynb .c1 { color: #408080; font-style: italic } /* Comment.Single */
    .highlight-ipynb .cs { color: #408080; font-style: italic } /* Comment.Special */
    .highlight-ipynb .gd { color: #A00000 } /* Generic.Deleted */
    .highlight-ipynb .ge { font-style: italic } /* Generic.Emph */
    .highlight-ipynb .gr { color: #FF0000 } /* Generic.Error */
    .highlight-ipynb .gh { color: #000080; font-weight: bold } /* Generic.Heading */
    .highlight-ipynb .gi { color: #00A000 } /* Generic.Inserted */
    .highlight-ipynb .go { color: #888888 } /* Generic.Output */
    .highlight-ipynb .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
    .highlight-ipynb .gs { font-weight: bold } /* Generic.Strong */
    .highlight-ipynb .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
    .highlight-ipynb .gt { color: #0044DD } /* Generic.Traceback */
    .highlight-ipynb .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
    .highlight-ipynb .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
    .highlight-ipynb .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
    .highlight-ipynb .kp { color: #008000 } /* Keyword.Pseudo */
    .highlight-ipynb .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
    .highlight-ipynb .kt { color: #B00040 } /* Keyword.Type */
    .highlight-ipynb .m { color: #666666 } /* Literal.Number */
    .highlight-ipynb .s { color: #BA2121 } /* Literal.String */
    .highlight-ipynb .na { color: #7D9029 } /* Name.Attribute */
    .highlight-ipynb .nb { color: #008000 } /* Name.Builtin */
    .highlight-ipynb .nc { color: #0000FF; font-weight: bold } /* Name.Class */
    .highlight-ipynb .no { color: #880000 } /* Name.Constant */
    .highlight-ipynb .nd { color: #AA22FF } /* Name.Decorator */
    .highlight-ipynb .ni { color: #999999; font-weight: bold } /* Name.Entity */
    .highlight-ipynb .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
    .highlight-ipynb .nf { color: #0000FF } /* Name.Function */
    .highlight-ipynb .nl { color: #A0A000 } /* Name.Label */
    .highlight-ipynb .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
    .highlight-ipynb .nt { color: #008000; font-weight: bold } /* Name.Tag */
    .highlight-ipynb .nv { color: #19177C } /* Name.Variable */
    .highlight-ipynb .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
    .highlight-ipynb .w { color: #bbbbbb } /* Text.Whitespace */
    .highlight-ipynb .mf { color: #666666 } /* Literal.Number.Float */
    .highlight-ipynb .mh { color: #666666 } /* Literal.Number.Hex */
    .highlight-ipynb .mi { color: #666666 } /* Literal.Number.Integer */
    .highlight-ipynb .mo { color: #666666 } /* Literal.Number.Oct */
    .highlight-ipynb .sb { color: #BA2121 } /* Literal.String.Backtick */
    .highlight-ipynb .sc { color: #BA2121 } /* Literal.String.Char */
    .highlight-ipynb .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
    .highlight-ipynb .s2 { color: #BA2121 } /* Literal.String.Double */
    .highlight-ipynb .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
    .highlight-ipynb .sh { color: #BA2121 } /* Literal.String.Heredoc */
    .highlight-ipynb .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
    .highlight-ipynb .sx { color: #008000 } /* Literal.String.Other */
    .highlight-ipynb .sr { color: #BB6688 } /* Literal.String.Regex */
    .highlight-ipynb .s1 { color: #BA2121 } /* Literal.String.Single */
    .highlight-ipynb .ss { color: #19177C } /* Literal.String.Symbol */
    .highlight-ipynb .bp { color: #008000 } /* Name.Builtin.Pseudo */
    .highlight-ipynb .vc { color: #19177C } /* Name.Variable.Class */
    .highlight-ipynb .vg { color: #19177C } /* Name.Variable.Global */
    .highlight-ipynb .vi { color: #19177C } /* Name.Variable.Instance */
    .highlight-ipynb .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>
    
    <style type="text/css">
    /* Overrides of notebook CSS for static HTML export */
    div.entry-content {
      overflow: visible;
      padding: 8px;
    }
    .input_area {
      padding: 0.2em;
    }
    
    a.heading-anchor {
     white-space: normal;
    }
    
    .rendered_html
    code {
     font-size: .8em;
    }
    
    pre.ipynb {
      color: black;
      background: #f7f7f7;
      border: none;
      box-shadow: none;
      margin-bottom: 0;
      padding: 0;
      margin: 0px;
      font-size: 13px;
    }
    
    /* remove the prompt div from text cells */
    div.text_cell .prompt {
        display: none;
    }
    
    /* remove horizontal padding from text cells, */
    /* so it aligns with outer body text */
    div.text_cell_render {
        padding: 0.5em 0em;
    }
    
    img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}
    
    div.collapseheader {
        width=100%;
        padding: 2px;
        cursor: pointer;
        font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
    }
    
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
    <script type="text/javascript">
    init_mathjax = function() {
        if (window.MathJax) {
            // MathJax loaded
            MathJax.Hub.Config({
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
                },
                displayAlign: 'center', // Change this to 'center' to center equations.
                "HTML-CSS": {
                    styles: {'.MathJax_Display': {"margin": 0}}
                }
            });
            MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    
    <link href="./extra/favicon.ico" rel="icon">

<link rel="canonical" href="./deploy-serverless-web-app-aws-lambda-zappa.html">

        <meta name="author" content="Peter D. Kazarinoff" />
        <meta name="keywords" content="python,flask,zappa,deployment,heroku" />
        <meta name="description" content="Zappa is a way to deploy serverless web apps on AWS Lambda. In this post, we will build a simple Flask web app with Python and run the web app on AWS Lambda using Zappa in only a few steps. Table of contents: What is Zappa? Install Zappa and Flask …" />

        <meta property="og:site_name" content="Python for Undergraduate Engineers" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Deploy a Serverless Web App on AWS Lambda with Zappa"/>
        <meta property="og:url" content="./deploy-serverless-web-app-aws-lambda-zappa.html"/>
        <meta property="og:description" content="Zappa is a way to deploy serverless web apps on AWS Lambda. In this post, we will build a simple Flask web app with Python and run the web app on AWS Lambda using Zappa in only a few steps. Table of contents: What is Zappa? Install Zappa and Flask …"/>
        <meta property="article:published_time" content="2020-01-14" />
            <meta property="article:section" content="web" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="flask" />
            <meta property="article:tag" content="zappa" />
            <meta property="article:tag" content="deployment" />
            <meta property="article:tag" content="heroku" />
            <meta property="article:author" content="Peter D. Kazarinoff" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/native.css" rel="stylesheet">
    <link href="./theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>
        <link href="./static/css/custom.css" rel="stylesheet">



</head>
<body>

<!-- .navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
Python for Undergraduate Engineers            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/about.html">
                             About
                          </a></li>
                         <li><a href="./pages/book.html">
                             Book
                          </a></li>
                         <li><a href="./pages/now.html">
                             Now
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">

<!-- .navbar-search -->
<li>
    <span>
        <form class="navbar-search" action="/search.html">
            <input type="text" name="q" id="tipue_search_input">
        </form>
    </span>
</li>
<!-- /.navbar-search -->              <li><a href="./archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-9">
            <ol class="breadcrumb">
                <li><a href="." title="Python for Undergraduate Engineers"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="./category/web.html" title="web">web</a></li>
                <li class="active">Deploy a Serverless Web App on AWS Lambda with Zappa</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./deploy-serverless-web-app-aws-lambda-zappa.html"
                       rel="bookmark"
                       title="Permalink to Deploy a Serverless Web App on AWS Lambda with Zappa">
                        Deploy a Serverless Web App on AWS Lambda with Zappa
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2020-01-14T09:01:00-08:00"> Tue 14 January 2020</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="./tag/python.html">python</a>
        /
	<a href="./tag/flask.html">flask</a>
        /
	<a href="./tag/zappa.html">zappa</a>
        /
	<a href="./tag/deployment.html">deployment</a>
        /
	<a href="./tag/heroku.html">heroku</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p><a href="./deploy-serverless-web-app-aws-lambda-zappa.html"><img alt="Zappa Icon" src="./posts/zappa/images/zappa_flask_lambda.png"></a></p>
<p>Zappa is a way to deploy serverless web apps on AWS Lambda. In this post, we will build a simple Flask web app with Python and run the web app on AWS Lambda using Zappa in only a few steps.</p>
<div class="toc"><span class="toctitle">Table of contents:</span><ul>
<li><a href="#what-is-zappa">What is Zappa?</a></li>
<li><a href="#install-zappa-and-flask">Install Zappa and Flask</a></li>
<li><a href="#a-simple-flask-app">A Simple Flask App</a></li>
<li><a href="#test-locally">Test Locally</a></li>
<li><a href="#aws-credentials">AWS Credentials</a><ul>
<li><a href="#sign-up-for-aws">Sign Up for AWS</a></li>
<li><a href="#create-aws-access-keys">Create AWS Access Keys</a><ul>
<li><a href="#1-create-a-group">1. Create a group</a></li>
<li><a href="#2-assign-an-inline-policy-to-the-group">2. Assign an inline policy to the group</a></li>
<li><a href="#3-create-a-user-and-add-the-user-to-the-group">3. Create a user and add the user to the group</a></li>
<li><a href="#4-copy-the-users-keys">4. Copy the user's keys</a></li>
</ul>
</li>
<li><a href="#copy-the-keys-to-a-credentials-file">Copy the Keys to a credentials File</a></li>
</ul>
</li>
<li><a href="#create-a-zappa_settingsjson-file">Create a zappa_settings.json File</a></li>
<li><a href="#save-a-requirementstxt-file">Save a requirements.txt File</a></li>
<li><a href="#deploy-on-aws">Deploy on AWS</a></li>
<li><a href="#modify-the-app-and-re-deploy">Modify the App and Re-deploy</a></li>
<li><a href="#shutdown-and-delete-the-app">Shutdown and Delete the App</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
</div>
<p><img alt="Zappa Icon" src="./posts/zappa/images/zappa_icon.png"></p>
<h1 id="what-is-zappa">What is Zappa?</h1>
<p><a href="https://github.com/Miserlou/Zappa">Zappa</a> is a Python package that bundles up web apps written in Flask or Django and deploys them to AWS (Amazon Web Services) Lambda. Lambda is Amazon's function as a service (FaaS) platorm. Why is Zappa so great? Because instead of deploying your Flask or Django web app on a cloud server, like an AWS EC2 instance or a Digital Ocean Droplet, you can deploy your app <em>serverless</em> as an AWS Lambda function.</p>
<p>This isn't really "serverless" (servers run AWS Lambda), but with an AWS Lambda function, you don't have to spin up servers, install packages, make sure security patches are up to date, and most of all: <strong>you don't have to pay for server time that isn't used.</strong> </p>
<blockquote>
<p>A cloud server has to run all the time, whether or not someone visits your website. But an AWS Lambda function only runs when requested.</p>
</blockquote>
<p>Think of it this way: Cloud servers are kind of like rental cars. AWS Lambda is sort of like calling an Uber. With Uber, you only pay for the rides you take. The rental car has to be paid for even when it's just sitting in your driveway. For only a trip or two in a month, Uber is pretty cheap compared to renting a car for a month.</p>
<p>So as long as your web traffic is low, running a web app serverless on AWS Lambda is pretty cheap compared to running a regular cloud server. AWS Lambda has a free tier. For a simple temporary hobby project, AWS is effectively free.</p>
<p>Also, serverless Lambda functions scale up and down based on demand. Continuing our car analogy: If you need to get 100 people to work, you can request 100 Ubers, but a rental car will only fit four adults.</p>
<p>Let's get started building our web app with Flask and deploying it on AWS Lambda with Zappa!</p>
<h1 id="install-zappa-and-flask">Install Zappa and Flask</h1>
<p>Before we can deploy our web app on AWS Lambda with Zappa, first we need to install Zappa and a web framework to build our web app with. In this project, we are going to build a <a href="https://www.palletsprojects.com/p/flask/">Flask</a> app, so Flask needs to be installed too. You can install both of these packages with <strong>pip</strong>, the Python package manager. </p>
<p>Using a terminal, create a project directory called <code>zappa_app</code> and <code>cd</code> into it. Create a virtual environment, activate it, and install Zappa and Flask.</p>
<div class="highlight"><pre><span></span>mkdir zappa_app
cd zappa_app
python -m venv venv
source venv/bin/activate
# on windows: venv\Scripts\activate
pip install flask
pip install zappa
</pre></div>


<p>You can verify the installation by calling two help commands at the terminal.</p>
<div class="highlight"><pre><span></span>flask --help
zappa --help
</pre></div>


<p>If you see the help sections of Flask and Zappa, both of the packages were successfully installed.</p>
<p><img alt="Flask Icon" src="./posts/zappa/images/flask_icon.png"></p>
<h1 id="a-simple-flask-app">A Simple Flask App</h1>
<p>Next, we'll build a simple web app with Flask. This web app is super small and basic, but it will give you an idea of how Zappa and AWS Lambda works.</p>
<p>The GitHub repo with all the code used in the rest of this post can be found here: <a href="https://github.com/ProfessorKazarinoff/flask-zappa-tutorial">https://github.com/ProfessorKazarinoff/flask-zappa-tutorial</a></p>
<p>Create a file called <code>app.py</code> in the main project directory <code>zappa_app</code> we created earlier. Inside <code>app.py</code>, paste the following code. This super simple Flask app creates one webpage that displays the text <strong>Yeah, that is Zappa! Zappa! Zap! Zap!</strong>. You can modify the text between the <code>&lt;h1&gt; .... &lt;/h1&gt;</code> tags to include any message you want.</p>
<p>Copy the code below into <code>app.py</code>.</p>
<div class="highlight"><pre><span></span># app.py

from flask import Flask
app = Flask(__name__)

@app.route(&#39;/&#39;)
def hello_world():
 return &#39;&lt;h1&gt;Yeah, that is Zappa! Zappa! Zap! Zap!&lt;/h1&gt;&#39;

# We only need this for local development.
if __name__ == &#39;__main__&#39;:
 app.run()
</pre></div>


<p>Ultimately, our web app will look something like the screen capture below.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/simple_app_webpage.png"></p>
<h1 id="test-locally">Test Locally</h1>
<p>Next, let's test the Flask app locally. We want to make sure the web app runs on our computer correctly before we deploy the app with Zappa on AWS Lambda. Run the command below in a terminal to test out our simple Flask app. Make sure to run the command in the virtual environment we installed Flask and Zappa into in the previous step. You should see <code>(venv)</code> before the terminal prompt.</p>
<div class="highlight"><pre><span></span>flask run
</pre></div>


<p>Browse to the URL shown in the terminal <a href="Running on http://127.0.0.1:5000/">http://127.0.0.1:5000/</a>. The webpage should look something like the screenshot below.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/flask_run_locally.png"></p>
<p><strong>Great! Our web app works locally.</strong> But before we can deploy our Flask app on AWS Lambda, there are a couple more steps. Next, we need to dive into AWS permissions and credentials. Put your seatbelt on.</p>
<h1 id="aws-credentials">AWS Credentials</h1>
<p>Before we can deploy our serverless web app on AWS Lambda, we need to create and save a set of AWS credentials in a <code>~/.aws/credentials</code> file.</p>
<h2 id="sign-up-for-aws">Sign Up for AWS</h2>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws_account_page.png"></p>
<p>If you don't have an AWS account, sign up here: <a href="https://aws.amazon.com/account/">https://aws.amazon.com/account/</a>. Signing up for an AWS account is free.</p>
<h2 id="create-aws-access-keys">Create AWS Access Keys</h2>
<p>Next, we need to create a new AWS <em>access key id</em> and <em>secret access key</em>. For me, this was kind of tricky. I mean <strong><em>how hard can it be to get an access key from AWS?</em></strong></p>
<p>Turns out permissions in AWS is a complicated beast.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/bear_scratch.jpg"></p>
<p>Log into your AWS account at <a href="https://aws.amazon.com/">https://aws.amazon.com/</a></p>
<p>Click the orange [Sign In to the Console] button on the upper right.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws_sign_into_the_console.png"></p>
<p>Within the AWS Console, type <code>IAM</code> into the search box. IAM is the AWS user and permissions dashboard.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/IAM_search.png"></p>
<p>Before we go any further, let's talk about permissions in AWS. This took me a while to figure this out. There are a couple of layers and roles to understand: accounts, groups, users, permissions, and policies.</p>
<ul>
<li><strong>Accounts</strong>: One person has an AWS account. An AWS account is usually defined by a username (email address) and password. Accounts are not the same thing as users.</li>
<li><strong>Users</strong>: Each account can have multiple users associated with it. The account administrator (you) can create new users and delete old users. Users have a set of permissions and policies that determines what they can do on AWS. Users can belong to groups and inherit any of the permissions or policies that come with that group. Each user has an <em>access key id</em> and <em>secret access key</em>. I generally do not assign permissions and policies to users. Instead, I usually have users inherit permissions and policies from a group.</li>
<li><strong>Groups</strong>: Each account can have multiple groups. Users belong to groups. A group has a particular set of permissions and policies that get passed to the users that are part of the group. Groups do not have access key id's or secret access keys. I generally assign permissions and policies to groups.</li>
<li><strong>Permissions</strong>: A permission is a small piece of work a user or group is allowed to do on AWS. For instance, one permission could allow a user or group to upload to an S3 bucket. Another permission could allow a user or group to shut down an EC2 instance. Permissions are grouped into policies.</li>
<li><strong>Policy</strong>: Policies are groups of permissions assembled together. Since a user will probably want to both upload and download from S3, these two permissions could be combined into one policy. Users and groups can have many policies assigned to them.</li>
<li><strong>Managed Policy</strong>: Managed policies are permissions grouped by Amazon that covers some sort of sub-functionality in AWS. For instance, one managed policy created by Amazon is AWSLambdaFullAccess. This managed policy allows a user or group to do anything on AWS Lambda. </li>
<li><strong>Inline Policy</strong>: Inline policies are permissions grouped together by you. You can pick individual permissions and assemble them into an inline policy. A user or group can have many inline and managed policies at the same time. Inline policies are stored in json format.</li>
</ul>
<p>To create the AWS credentials needed to run our web app, we need to complete a couple of steps:</p>
<ol>
<li>Create a group</li>
<li>Assign an inline policy to the group</li>
<li>Create a user and add the user to the group</li>
<li>Copy the user's keys</li>
</ol>
<h3 id="1-create-a-group">1. Create a group</h3>
<p>In the IAM Dashboard, click [Groups] on the left-hand menu. </p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/5.png"></p>
<p>Then create a new group with the [Create New Group] button.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/6.png"></p>
<p>Give your group a name, I called my group <code>zappa_group</code>, and click [Next Step].</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/7.png"></p>
<p>In the Attach Policy screen, don't check any radio boxes, just click [Next Step]. All of the attached policy options are AWS managed policies. We want to create our own specific inline policy for our zappa_group, so we don't need to select any pre-selected AWS policies.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/8.png"></p>
<p>At the review screen, review the group you created and click [Create Group]. </p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/9.png"></p>
<p>Next, we will copy and paste an inline policy written in json format and assign our custom inline policy to our group.</p>
<h3 id="2-assign-an-inline-policy-to-the-group">2. Assign an inline policy to the group</h3>
<p><strong>Double, double toil and trouble...</strong> I had a tough time figuring out which AWS security permissions I needed to attach to my AWS User to get Zappa to work. In the end, I attached one manually-created custom inline policy to the group.</p>
<p>I think it's a good idea to attach the security policy to a group. Then you can add and delete users easily without losing any info in the security policy. </p>
<p>At the Groups main screen, click on the group you just created to view the group's details.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/10.png"></p>
<p>In the Permissions tab, under the Inline Policies section, choose the [click here] link to create a new Inline Policy.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/11.png"></p>
<p>In the Set Permissions screen, click the Custom Policy radio button and click the [Select] button on the right. We could use the policy generator to create our inline policy, but instead, we will create a Custom Policy written in json format.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/13.png"></p>
<p>Type a policy name and paste the json below into the Policy Document window.</p>
<p>Note the <code>XXXXXXXXXXX</code> in the inline policy should be replaced by your AWS Account Number.</p>
<p>Your AWS Account Number can be found by clicking [Support] &rarr; [Support Center]. Your Account Number is listed in the Support Center on the upper left-hand side.</p>
<p>The json for the inline policy applied to the group is below.</p>
<div class="highlight"><pre><span></span>{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
      {
        &quot;Effect&quot;: &quot;Allow&quot;,
        &quot;Action&quot;: [
          &quot;iam:AttachRolePolicy&quot;,
          &quot;iam:GetRole&quot;,
          &quot;iam:CreateRole&quot;,
          &quot;iam:PassRole&quot;,
          &quot;iam:PutRolePolicy&quot;
        ],
        &quot;Resource&quot;: [
          &quot;arn:aws:iam::XXX_MY_AWS_ACCOUNT_ID_XXX:role/*-ZappaLambdaExecutionRole&quot;
        ]
      },
      {
        &quot;Effect&quot;: &quot;Allow&quot;,
        &quot;Action&quot;: [
          &quot;apigateway:DELETE&quot;,
          &quot;apigateway:GET&quot;,
          &quot;apigateway:PATCH&quot;,
          &quot;apigateway:POST&quot;,
          &quot;apigateway:PUT&quot;,
          &quot;events:DeleteRule&quot;,
          &quot;events:DescribeRule&quot;,
          &quot;events:ListRules&quot;,
          &quot;events:ListRuleNamesByTarget&quot;,
          &quot;events:ListTargetsByRule&quot;,
          &quot;events:PutRule&quot;,
          &quot;events:PutTargets&quot;,
          &quot;events:RemoveTargets&quot;,
          &quot;lambda:AddPermission&quot;,
          &quot;lambda:CreateFunction&quot;,
          &quot;lambda:DeleteFunction&quot;,
          &quot;lambda:GetAlias&quot;,
          &quot;lambda:GetFunction&quot;,
          &quot;lambda:GetFunctionConfiguration&quot;,
          &quot;lambda:GetPolicy&quot;,
          &quot;lambda:InvokeFunction&quot;,
          &quot;lambda:DeleteFunctionConcurrency&quot;,
          &quot;lambda:ListVersionsByFunction&quot;,
          &quot;lambda:RemovePermission&quot;,
          &quot;lambda:UpdateFunctionCode&quot;,
          &quot;lambda:UpdateFunctionConfiguration&quot;,
          &quot;cloudformation:CreateStack&quot;,
          &quot;cloudformation:DeleteStack&quot;,
          &quot;cloudformation:DescribeStackResource&quot;,
          &quot;cloudformation:DescribeStacks&quot;,
          &quot;cloudformation:ListStackResources&quot;,
          &quot;cloudformation:UpdateStack&quot;,
          &quot;cloudfront:UpdateDistribution&quot;,
          &quot;logs:DeleteLogGroup&quot;,
          &quot;logs:DescribeLogStreams&quot;,
          &quot;logs:FilterLogEvents&quot;,
          &quot;route53:ListHostedZones&quot;
        ],
        &quot;Resource&quot;: [
          &quot;*&quot;
        ]
      },
      {
        &quot;Effect&quot;: &quot;Allow&quot;,
        &quot;Action&quot;: [
          &quot;s3:CreateBucket&quot;,
          &quot;s3:ListBucket&quot;,
          &quot;s3:ListBucketMultipartUploads&quot;
        ],
        &quot;Resource&quot;: [
          &quot;arn:aws:s3:::zappa-*&quot;
        ]
      },
      {
        &quot;Effect&quot;: &quot;Allow&quot;,
        &quot;Action&quot;: [
          &quot;s3:DeleteObject&quot;,
          &quot;s3:GetObject&quot;,
          &quot;s3:PutObject&quot;,
          &quot;s3:AbortMultipartUpload&quot;,
          &quot;s3:ListMultipartUploadParts&quot;
        ],
        &quot;Resource&quot;: [
          &quot;arn:aws:s3:::zappa-*/*&quot;
        ]
      }
    ]
  }
</pre></div>


<p>After pasting and modifying the json with your AWS Account Number, click the [Validate Policy] button to ensure you copied valid json. Then click the [Apply Policy] button to attach the inline policy to the group.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/14.png"></p>
<p>The json above is what worked for me. But, I expect this set of security permissions may be too open. To increase security, you could slowly pare down the permissions and see if Zappa still deploys. The settings above are the ones that finally worked for me. You can dig through this discussion on GitHub if you want to learn more about specific AWS permissions needed to run Zappa: <a href="https://github.com/Miserlou/Zappa/issues/244">https://github.com/Miserlou/Zappa/issues/244</a>.</p>
<h3 id="3-create-a-user-and-add-the-user-to-the-group">3. Create a user and add the user to the group</h3>
<p>Back at the IAM Dashboard, create a new user with the [Users] left-hand menu option and the [Add User] button.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/15.png"></p>
<p>In the Add user screen, give your new user a name and select the Access Type for Programmatic access. Then click the [Next: Permissions] button.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/16.png"></p>
<p>In the Set permissions screen, select the group you created earlier in the Add user to group section and click [Next: Tags].</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/17.png"></p>
<p>Tags are optional. Add tags if you want, then click [Next: Review].</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/IAM_add_tags.png"></p>
<p>Review the user details and click [Create user]</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/aws/19.png"></p>
<p>You should now be able to see your new user attached to your new group. Hopefully, you see a green Success screen.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/IAM_user_success.png"></p>
<h3 id="4-copy-the-users-keys">4. Copy the user's keys</h3>
<p>Click the [Show] button under the Secret access key heading. You should now be able to see both the <em>Access key ID</em> and the <em>Secret access key</em>. We need both of these keys to deploy our Zappa app.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/IAM_secrets_shown.png"></p>
<p>Don't close the AWS IAM window yet. In the next step, you will copy and paste these keys into a file. At this point, it's not a bad idea  to copy and save these keys into a text file in a secure location. <strong>Make sure you don't save keys under version control.</strong></p>
<h2 id="copy-the-keys-to-a-credentials-file">Copy the Keys to a credentials File</h2>
<p>Save the AWS <strong>access key id</strong> and <strong>secret access key</strong> assigned to the User you created in the file <code>~/.aws/credentials</code>. Note the <code>.aws/</code> directory needs to be in your home directory and the <code>credentials</code> file has no file extension.</p>
<blockquote>
<p><strong>Note:</strong> On Windows, save the credentials file in <code>C:\&gt; dir "%UserProfile%\.aws</code></p>
</blockquote>
<p>In the <code>credentials</code> file, copy the text below then modify the <code>XXXXXXXX</code> portions to include your User's keys (no quotes).</p>
<div class="highlight"><pre><span></span>[default]
aws_access_key_id = XXXXXXXXXXXXXXXXXXXXXXXXXX
aws_secret_access_key = XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</pre></div>


<p>Now that our AWS credentials are set, close the AWS IAM browser window. Almost time to <strong>let Zappa do it's magic!</strong></p>
<h1 id="create-a-zappa_settingsjson-file">Create a zappa_settings.json File</h1>
<p>Next, we need to create the Zappa settings file: <code>zappa_settings.json</code>. Create this file by typing the command <code>zappa init</code> into a terminal (remember the virtual environment <code>(venv)</code> needs to be active when the command is entered).</p>
<div class="highlight"><pre><span></span>zappa init
</pre></div>


<p>The command creates a <code>zappa_settings.json</code> file in the directory where the command was run.</p>
<p>Edit the <code>zappa_settings.json</code> file so that the <code>"profile_name": "default"</code> corresponds to the name in square brackets we specified in <code>.aws/credentials</code>. The <code>"aws_region"</code> also needs to be set. I'm in Oregon, so I choose <code>"us-west-2"</code>. All other default settings from <code>zappa init</code> are OK. Note the <code>"s3_bucket"</code> name may be different for you. Zappa automatically creates a random S3 bucket name. </p>
<p>The complete <code>zappa_settings.json</code> file is below:</p>
<div class="highlight"><pre><span></span>{
 &quot;dev&quot;: {
 &quot;app_function&quot;: &quot;app.app&quot;,
 &quot;profile_name&quot;: &quot;default&quot;,
 &quot;project_name&quot;: &quot;zappa-flask-app&quot;,
 &quot;runtime&quot;: &quot;python3.7&quot;,
 &quot;s3_bucket&quot;: &quot;zappa-9cf4j0c1h&quot;,
 &quot;aws_region&quot;: &quot;us-west-2&quot;
 }
}
</pre></div>


<h1 id="save-a-requirementstxt-file">Save a requirements.txt File</h1>
<p>Before we deploy our web app on AWS Lambda (we are almost done!), we'll create a <code>requirements.txt</code> file using <code>pip freeze</code>.</p>
<div class="highlight"><pre><span></span>pip freeze &gt; requirements.txt
</pre></div>


<blockquote>
<p><strong>NOTE:</strong> I saved my project directory in a <a href="https://github.com/ProfessorKazarinoff/flask-zappa-tutorial">GitHub repo</a> and included a <code>LICENSE</code>, <code>.gitignore</code> and a <code>README.md</code>. Saving the project on GitHub isn't necessary, but I like to keep my code in multiple places and GitHub acts as the central storage location for the project.</p>
</blockquote>
<p>The following files should now be in the main project directory <code>zappa_app</code>:</p>
<div class="highlight"><pre><span></span>zappa_app/
├── app.py
├── requirements.txt
├── venv/
└── zappa_settings.json
</pre></div>


<h1 id="deploy-on-aws">Deploy on AWS</h1>
<p><strong>It's time to deploy our Flask app on AWS Lambda!</strong> Deploy the web app with the command below:</p>
<div class="highlight"><pre><span></span>zappa deploy dev
</pre></div>


<p>If everything worked, you should be able to browse to the URL listed in the terminal (something like https://heq5x2wioxcz.execute-api.us-west-2.amazonaws.com/dev) and see your web app running in all its serverless glory.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/Zappa_app_running.png"></p>
<p>Pretty Cool. We got a serverless Flask app running on AWS Lambda.</p>
<h1 id="modify-the-app-and-re-deploy">Modify the App and Re-deploy</h1>
<p>We can modify our app and see the results live on the web. Open the <code>app.py</code> file and change the text in between the <code>&lt;h1&gt; ... &lt;/h1&gt;</code> tags. You can change the message to display any text you want.</p>
<div class="highlight"><pre><span></span># app.py
...

@app.route(&#39;/&#39;)
def hello_world():
 return &#39;&lt;h1&gt;Yeah, that is Zappa! Zappa! Zap! Zap! I am revised&lt;/h1&gt;&#39;

...
</pre></div>


<p>Re-deploy the app with the command below:</p>
<div class="highlight"><pre><span></span>zappa update dev
</pre></div>


<p>Reload your browser and see the modified text.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/Zappa_app_running_revised.png"></p>
<h1 id="shutdown-and-delete-the-app">Shutdown and Delete the App</h1>
<p>At some point, you will want to shut down and delete your app. Who knows, maybe your app becomes super popular and your AWS bill goes through the roof? (we can only hope). To shutdown the Zappa app, type the following command:</p>
<div class="highlight"><pre><span></span>zappa undeploy dev
</pre></div>


<h1 id="summary">Summary</h1>
<p>In this post, we created a simple web app with Flask and deployed it to AWS Lambda with Zappa. We completed the project in a few steps. First, we built a simple Flask app and ran it locally. Next, we messed around with AWS permissions and saved an access key id and secret access key in <code>~/.aws/credentials</code>. Finally, we ran <code>zappa init</code> and <code>zappa deploy dev</code> to deploy our web app on AWS Lambda. It's amazing how little code you need to write to deploy a serverless Flask app on AWS Lambda with Zappa.</p>
<p><img alt="zappa zap zap" src="./posts/zappa/images/rabbits_kissing.jpg"></p>
<p>The GitHub repo with all the code used in this post can be found here: <a href="https://github.com/ProfessorKazarinoff/flask-zappa-tutorial">https://github.com/ProfessorKazarinoff/flask-zappa-tutorial</a></p>
<p><strong>Happy Zapping!</strong></p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="./deploy-jupyter-notebook-voila-heroku.html">Deploy a Jupyter Notebook Online with Voila and Heroku</a></li>
        <li><a href="./flask-iot-server-upload-code-to-esp8266.html">Building an IoT Server with flask and Python - Part 6 - upload code to ESP8266-based WiFi weather stations</a></li>
        <li><a href="./flask-iot-server-database.html">Building an IoT Server with flask and Python - Part 5 Adding a Database</a></li>
        <li><a href="./flask-iot-server-validation-time-stamps.html">Building an IoT Server with flask and Python - Part 4 Validation and Timestamps</a></li>
        <li><a href="./flask-iot-server-web-API.html">Building an IoT Server with flask and Python - Part 3 Web API</a></li>
    </ul>
</section>
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
    </div>
    <!-- AddThis Button END -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="./extra/gear-wrench-icon-512-278694.png"/>
        </p>
    <p>
      <strong>About Peter Kazarinoff</strong><br/>
        I teach engineering at a community college in the Pacific Northwest. I am interested in programming and how to help students. Here I mostly blog about Python, and how programing can be incorporated into engineering education.
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./thoughts-on-software-design-in-scientific-code.html">Thoughts on Software Design in Scientific Code</a></li>
    <li class="list-group-item"><a href="./stream-S01-E01-jupyterhub-intro.html">My first Twitch Stream: S01-E01 JupyterHub Intro and Tools</a></li>
    <li class="list-group-item"><a href="./jupyterhub-deployment-on-running-in-production.html">Hear my story about deploying JupyterHub on the Running in Production Podcast</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="./"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group list-inline tagcloud" id="tags">
    <li class="list-group-item tag-2">
      <a href="./tag/engineering.html">engineering</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/esp8266.html">esp8266</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/flask.html">flask</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="./tag/jupyter.html">jupyter</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/jupyter-notebook.html">jupyter notebook</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="./tag/matplotlib.html">matplotlib</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/micropython.html">micropython</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/pelican.html">pelican</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="./tag/python.html">python</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/sensor.html">sensor</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->

<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/professorkazarinoff">@professorkazarinoff</a> on GitHub
</li>
<!-- End Sidebar/Github -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2021 Peter Kazarinoff
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>

    <script src="./static/js/custom.js"></script>


<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = './theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  github.showRepos({
    user: 'professorkazarinoff',
    count: 5,
    skip_forks: true,
    target: '#gh_repos'
  });
});
</script>
<script src="./theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-116330557-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cdd8eb4e16bf94c"></script>
</body>
</html>