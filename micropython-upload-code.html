<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Upload Micropython Code to an Adafruit Feather Huzzah ESP8266 - Python for Undergraduate Engineers</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




<style type="text/css">

    /*some stuff for output/input prompts*/
    div.cell{border:1px solid transparent;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}div.cell.selected{border-radius:4px;border:thin #ababab solid}
    div.cell.edit_mode{border-radius:4px;border:thin #008000 solid}
    div.cell{width:100%;padding:5px 5px 5px 0;margin:0;outline:none}
    div.prompt{min-width:11ex;padding:.4em;margin:0;font-family:monospace;text-align:right;line-height:1.21429em}
    @media (max-width:480px){div.prompt{text-align:left}}div.inner_cell{display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;flex:1}
    div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;line-height:1.21429em}
    div.prompt:empty{padding-top:0;padding-bottom:0}
    div.input{page-break-inside:avoid;display:-webkit-box;-webkit-box-orient:horizontal;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:horizontal;-moz-box-align:stretch;display:box;box-orient:horizontal;box-align:stretch;}
    div.inner_cell{width:90%;}
    div.input_area{border:1px solid #cfcfcf;border-radius:4px;background:#f7f7f7;}
    div.input_prompt{color:navy;border-top:1px solid transparent;}
    div.output_wrapper{margin-top:5px;position:relative;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
    div.output_scroll{height:24em;width:100%;overflow:auto;border-radius:4px;-webkit-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);-moz-box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);box-shadow:inset 0 2px 8px rgba(0, 0, 0, 0.8);}
    div.output_collapsed{margin:0px;padding:0px;display:-webkit-box;-webkit-box-orient:vertical;-webkit-box-align:stretch;display:-moz-box;-moz-box-orient:vertical;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;width:100%;}
    div.out_prompt_overlay{height:100%;padding:0px 0.4em;position:absolute;border-radius:4px;}
    div.out_prompt_overlay:hover{-webkit-box-shadow:inset 0 0 1px #000000;-moz-box-shadow:inset 0 0 1px #000000;box-shadow:inset 0 0 1px #000000;background:rgba(240, 240, 240, 0.5);}
    div.output_prompt{color:darkred;}
    
    a.anchor-link:link{text-decoration:none;padding:0px 20px;visibility:hidden;}
    h1:hover .anchor-link,h2:hover .anchor-link,h3:hover .anchor-link,h4:hover .anchor-link,h5:hover .anchor-link,h6:hover .anchor-link{visibility:visible;}
    /* end stuff for output/input prompts*/
    
    
    .highlight-ipynb .hll { background-color: #ffffcc }
    .highlight-ipynb  { background: #f8f8f8; }
    .highlight-ipynb .c { color: #408080; font-style: italic } /* Comment */
    .highlight-ipynb .err { border: 1px solid #FF0000 } /* Error */
    .highlight-ipynb .k { color: #008000; font-weight: bold } /* Keyword */
    .highlight-ipynb .o { color: #666666 } /* Operator */
    .highlight-ipynb .cm { color: #408080; font-style: italic } /* Comment.Multiline */
    .highlight-ipynb .cp { color: #BC7A00 } /* Comment.Preproc */
    .highlight-ipynb .c1 { color: #408080; font-style: italic } /* Comment.Single */
    .highlight-ipynb .cs { color: #408080; font-style: italic } /* Comment.Special */
    .highlight-ipynb .gd { color: #A00000 } /* Generic.Deleted */
    .highlight-ipynb .ge { font-style: italic } /* Generic.Emph */
    .highlight-ipynb .gr { color: #FF0000 } /* Generic.Error */
    .highlight-ipynb .gh { color: #000080; font-weight: bold } /* Generic.Heading */
    .highlight-ipynb .gi { color: #00A000 } /* Generic.Inserted */
    .highlight-ipynb .go { color: #888888 } /* Generic.Output */
    .highlight-ipynb .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
    .highlight-ipynb .gs { font-weight: bold } /* Generic.Strong */
    .highlight-ipynb .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
    .highlight-ipynb .gt { color: #0044DD } /* Generic.Traceback */
    .highlight-ipynb .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
    .highlight-ipynb .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
    .highlight-ipynb .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
    .highlight-ipynb .kp { color: #008000 } /* Keyword.Pseudo */
    .highlight-ipynb .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
    .highlight-ipynb .kt { color: #B00040 } /* Keyword.Type */
    .highlight-ipynb .m { color: #666666 } /* Literal.Number */
    .highlight-ipynb .s { color: #BA2121 } /* Literal.String */
    .highlight-ipynb .na { color: #7D9029 } /* Name.Attribute */
    .highlight-ipynb .nb { color: #008000 } /* Name.Builtin */
    .highlight-ipynb .nc { color: #0000FF; font-weight: bold } /* Name.Class */
    .highlight-ipynb .no { color: #880000 } /* Name.Constant */
    .highlight-ipynb .nd { color: #AA22FF } /* Name.Decorator */
    .highlight-ipynb .ni { color: #999999; font-weight: bold } /* Name.Entity */
    .highlight-ipynb .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
    .highlight-ipynb .nf { color: #0000FF } /* Name.Function */
    .highlight-ipynb .nl { color: #A0A000 } /* Name.Label */
    .highlight-ipynb .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
    .highlight-ipynb .nt { color: #008000; font-weight: bold } /* Name.Tag */
    .highlight-ipynb .nv { color: #19177C } /* Name.Variable */
    .highlight-ipynb .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
    .highlight-ipynb .w { color: #bbbbbb } /* Text.Whitespace */
    .highlight-ipynb .mf { color: #666666 } /* Literal.Number.Float */
    .highlight-ipynb .mh { color: #666666 } /* Literal.Number.Hex */
    .highlight-ipynb .mi { color: #666666 } /* Literal.Number.Integer */
    .highlight-ipynb .mo { color: #666666 } /* Literal.Number.Oct */
    .highlight-ipynb .sb { color: #BA2121 } /* Literal.String.Backtick */
    .highlight-ipynb .sc { color: #BA2121 } /* Literal.String.Char */
    .highlight-ipynb .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
    .highlight-ipynb .s2 { color: #BA2121 } /* Literal.String.Double */
    .highlight-ipynb .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
    .highlight-ipynb .sh { color: #BA2121 } /* Literal.String.Heredoc */
    .highlight-ipynb .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
    .highlight-ipynb .sx { color: #008000 } /* Literal.String.Other */
    .highlight-ipynb .sr { color: #BB6688 } /* Literal.String.Regex */
    .highlight-ipynb .s1 { color: #BA2121 } /* Literal.String.Single */
    .highlight-ipynb .ss { color: #19177C } /* Literal.String.Symbol */
    .highlight-ipynb .bp { color: #008000 } /* Name.Builtin.Pseudo */
    .highlight-ipynb .vc { color: #19177C } /* Name.Variable.Class */
    .highlight-ipynb .vg { color: #19177C } /* Name.Variable.Global */
    .highlight-ipynb .vi { color: #19177C } /* Name.Variable.Instance */
    .highlight-ipynb .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>
    
    <style type="text/css">
    /* Overrides of notebook CSS for static HTML export */
    div.entry-content {
      overflow: visible;
      padding: 8px;
    }
    .input_area {
      padding: 0.2em;
    }
    
    a.heading-anchor {
     white-space: normal;
    }
    
    .rendered_html
    code {
     font-size: .8em;
    }
    
    pre.ipynb {
      color: black;
      background: #f7f7f7;
      border: none;
      box-shadow: none;
      margin-bottom: 0;
      padding: 0;
      margin: 0px;
      font-size: 13px;
    }
    
    /* remove the prompt div from text cells */
    div.text_cell .prompt {
        display: none;
    }
    
    /* remove horizontal padding from text cells, */
    /* so it aligns with outer body text */
    div.text_cell_render {
        padding: 0.5em 0em;
    }
    
    img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}
    
    div.collapseheader {
        width=100%;
        padding: 2px;
        cursor: pointer;
        font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
    }
    
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>
    <script type="text/javascript">
    init_mathjax = function() {
        if (window.MathJax) {
            // MathJax loaded
            MathJax.Hub.Config({
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
                },
                displayAlign: 'center', // Change this to 'center' to center equations.
                "HTML-CSS": {
                    styles: {'.MathJax_Display': {"margin": 0}}
                }
            });
            MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    
    <link href="./extra/favicon.ico" rel="icon">

<link rel="canonical" href="./micropython-upload-code.html">

        <meta name="author" content="Peter D. Kazarinoff" />
        <meta name="keywords" content="python,micropython,esp8266,microcontroller,sensor" />
        <meta name="description" content="This is the sixth part of a multi-part series on Micropython. In this post, we will upload .py files to an Adafruit Feather Huzzah ESP8266 board using Python and a Python package called ampy. At the end of the post we will have a working WiFi weather station that will …" />

        <meta property="og:site_name" content="Python for Undergraduate Engineers" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Upload Micropython Code to an Adafruit Feather Huzzah ESP8266"/>
        <meta property="og:url" content="./micropython-upload-code.html"/>
        <meta property="og:description" content="This is the sixth part of a multi-part series on Micropython. In this post, we will upload .py files to an Adafruit Feather Huzzah ESP8266 board using Python and a Python package called ampy. At the end of the post we will have a working WiFi weather station that will …"/>
        <meta property="article:published_time" content="2018-07-27" />
            <meta property="article:section" content="micropython" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="micropython" />
            <meta property="article:tag" content="esp8266" />
            <meta property="article:tag" content="microcontroller" />
            <meta property="article:tag" content="sensor" />
            <meta property="article:author" content="Peter D. Kazarinoff" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.flatly.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/native.css" rel="stylesheet">
    <link href="./theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>
        <link href="./static/css/custom.css" rel="stylesheet">



</head>
<body>

<!-- .navbar -->
<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
Python for Undergraduate Engineers            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/about.html">
                             About
                          </a></li>
                         <li><a href="./pages/book.html">
                             Book
                          </a></li>
                         <li><a href="./pages/now.html">
                             Now
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">

<!-- .navbar-search -->
<li>
    <span>
        <form class="navbar-search" action="/search.html">
            <input type="text" name="q" id="tipue_search_input">
        </form>
    </span>
</li>
<!-- /.navbar-search -->              <li><a href="./archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-9">
            <ol class="breadcrumb">
                <li><a href="." title="Python for Undergraduate Engineers"><i class="fa fa-home fa-lg"></i></a></li>
                <li><a href="./category/micropython.html" title="micropython">micropython</a></li>
                <li class="active">Upload Micropython Code to an Adafruit Feather Huzzah ESP8266</li>
            </ol>
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./micropython-upload-code.html"
                       rel="bookmark"
                       title="Permalink to Upload Micropython Code to an Adafruit Feather Huzzah ESP8266">
                        Upload Micropython Code to an Adafruit Feather Huzzah ESP8266
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2018-07-27T09:01:00-07:00"> Fri 27 July 2018</time>
    </span>

            <span class="label label-default">Series</span>
            Part 6 of micropython




<span class="label label-default">Tags</span>
	<a href="./tag/python.html">python</a>
        /
	<a href="./tag/micropython.html">micropython</a>
        /
	<a href="./tag/esp8266.html">esp8266</a>
        /
	<a href="./tag/microcontroller.html">microcontroller</a>
        /
	<a href="./tag/sensor.html">sensor</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This is the sixth part of a multi-part series on Micropython. In this post, we will upload <strong><em>.py</em></strong> files to an Adafruit Feather Huzzah ESP8266 board using Python and a Python package called <strong>ampy</strong>. At the end of the post we will have a working WiFi weather station that will post the temperature to ThingSpeak.com</p>
<p>Before we can use the Microython REPL (the Micropython prompt) running on the Adafruit Feather Huzzah ESP8266, <a href="https://docs.micropython.org/en/latest/esp8266/esp8266/tutorial/intro.html">Micropython</a> needs to be installed on the ESP8266 board and <a href="https://www.putty.org/">PuTTY</a> needs to be installed on the computer to communicate with the board over a serial connection. See a <a href="./micropython-install.html">previous post</a> on how to install Micropython on an ESP8266 board and how to install PuTTY on a Windows 10 machine.</p>
<p>Summary of Steps:</p>
<ol>
<li>Install <strong>ampy</strong> with <strong>pip</strong></li>
<li>Write Python code in <strong><em>.py</em></strong> files</li>
<li>Upload the <strong><em>.py</em></strong> files to the board with <strong>ampy</strong></li>
<li>Unplug and power up the Feather Huzzah and watch the data on ThingSpeak.com</li>
</ol>
<h3 id="1-install-ampy-with-pip">1. Install <strong>ampy</strong> with <strong>pip</strong></h3>
<p><a href="https://github.com/adafruit/ampy"><strong>Ampy</strong></a> is a tool written by the good folks at Adafruit. <strong>Ampy</strong> is used to upload files onto the ESP8266. Since I'm using a virtual environment, I need to activate the virtual environment first before installing <strong>ampy</strong>. Note that the tool is called <strong>ampy</strong>, but we <code>pip install ampy-adafruit</code>.</p>
<div class="highlight"><pre><span></span>$ conda activate micropython
<span class="o">(</span>micropython<span class="o">)</span> $ pip install ampy-adafruit
<span class="o">(</span>micropython<span class="o">)</span> $ ampy --help
</pre></div>


<h3 id="2-write-python-code-in-py-files">2. Write Python code in <strong><em>.py</em></strong> files</h3>
<p>Now we need to write the Python code in <strong><em>.py</em></strong> files that will run on the ESP8266 board. The board already contains two main Python files: <strong><em>boot.py</em></strong> and <strong><em>main.py</em></strong>. We can also add additional files to the board. <strong><em>boot.py</em></strong> is the file that runs first when the board is powered up. After <strong><em>boot.py</em></strong> runs, then <strong><em>main.py</em></strong> runs. We can add other <strong><em>.py</em></strong> files to the board to provide <strong><em>main.py</em></strong> some functions and classes to work with. We have two general things to do with our Feather board: read the temperature and post the temperature to the ThingSpeak.com. We'll use a different <strong><em>.py</em></strong> file for each of these two general tasks. </p>
<p>The first module, <strong><em>MCP9808.py</em></strong>, will simplify reading temperature data off of the <a href="https://www.adafruit.com/product/1782">Adafruit MCP9808</a> temperature sensor breakout. We need to write a <code>readtemp()</code> function that parses out the temperature data from the I2C bus and outputs the temperature as a float. The <code>readtemp()</code> function needs to import the <code>machine</code> module to use the I2C bus. The machine module allows us to create a new I2C object. When we instantiate the I2C object object, we need to specify the <code>scl</code> and <code>sda</code> pins connected to the sensor. <code>scl</code> is the I2C clock line and <code>sda</code> is the I2C data line. on the Adafruit Feather Huzzah <code>scl</code> is pin 5 and <code>sda</code> is pin 4 . Then a new byte array variable needs to be created. </p>
<p>A byte array is needed to store the temperature data when it comes over the I2C line from the sensor to the board.  Then we need to read the sensor data using the <code>i2c.readfrom_mem_into()</code> function. The first argument is the I2C bus address of the sensor. In our case, the sensor is at I2C bus address <code>24</code>. You can use the line <code>&gt;&gt;&gt; i2c.scan()</code> in the Micropython REPL to see this value.  The next argument passed to the <code>i2c.readfrom_mem_into()</code> function is the register on the MCP9808 temperature sensor where the temperature value is stored. The temperature is stored on the MCP9808 in register <code>5</code>. When we access register <code>5</code> on the MCP9808, we read in the temperature. The final argument passed into the  <code>i2c.readfrom_mem_into()</code> function is the byte array variable that stores the temperature data. The <code>i2c.readfrom_mem_into()</code> function modifies the variable passed to it as a function argument, rather than producing a variable which is the function output as most functions do. This is why we needed to first create the <code>byte_data</code> variable before calling the <code>i2c.readfrom_mem_into()</code> function. Finally, we need to do some post processing of the byte array to transform it into a temperature in degrees C. <code>The complete readtemp()</code> function is below:</p>
<div class="highlight"><pre><span></span><span class="c1"># MCP9808.py</span>

<span class="c1"># Functions for the  MCP9808 temperature sensor</span>
<span class="c1"># https://learn.adafruit.com/micropython-hardware-i2c-devices/i2c-master</span>

<span class="k">def</span> <span class="nf">readtemp</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">machine</span>
    <span class="n">i2c</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">I2C</span><span class="p">(</span><span class="n">scl</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">sda</span><span class="o">=</span><span class="n">machine</span><span class="o">.</span><span class="n">Pin</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="n">byte_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">i2c</span><span class="o">.</span><span class="n">readfrom_mem_into</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">byte_data</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">byte_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">byte_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">/</span> <span class="mf">16.0</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">:</span>
        <span class="n">temp</span> <span class="o">-=</span> <span class="mf">256.0</span>
    <span class="k">return</span> <span class="n">temp</span>
</pre></div>


<p>Now we'll build a Python file that contains a set of WiFi functions called <strong><em>wifitools.py</em></strong>. We used this same functionally in a <a href="./micropython-wifi.html">previous post</a> to connect the ESP8266 to a WiFi network. In addition to the WiFi functions, we also need a function to build the ThingSpeak.com web API URL. This is the URL we will request in order to get our temperature posted on ThingSpeak.com.</p>
<div class="highlight"><pre><span></span><span class="c1">#wifitools.py</span>

<span class="c1"># Wifi connection and ThingSpeak.com post functions for an ESP8266 board running Micropython</span>
<span class="c1">#https://docs.micropython.org/en/v1.8.6/esp8266/esp8266/tutorial/network_basics.html</span>

<span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">SSID</span><span class="p">,</span><span class="n">password</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">network</span>
    <span class="n">sta_if</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">WLAN</span><span class="p">(</span><span class="n">network</span><span class="o">.</span><span class="n">STA_IF</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sta_if</span><span class="o">.</span><span class="n">isconnected</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;connecting to network...&#39;</span><span class="p">)</span>
        <span class="n">sta_if</span><span class="o">.</span><span class="n">active</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sta_if</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">SSID</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">sta_if</span><span class="o">.</span><span class="n">isconnected</span><span class="p">():</span>
            <span class="k">pass</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;network config:&#39;</span><span class="p">,</span> <span class="n">sta_if</span><span class="o">.</span><span class="n">ifconfig</span><span class="p">())</span>

<span class="c1">#https://docs.micropython.org/en/v1.8.6/esp8266/esp8266/tutorial/network_tcp.html</span>
<span class="k">def</span> <span class="nf">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">socket</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="mi">80</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s1">&#39;GET /</span><span class="si">%s</span><span class="s1"> HTTP/1.0</span><span class="se">\r\n</span><span class="s1">Host: </span><span class="si">%s</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">host</span><span class="p">),</span> <span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

<span class="k">def</span> <span class="nf">thingspeak_post</span><span class="p">(</span><span class="n">API_key</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isintance</span><span class="p">(</span><span class="n">API_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">API_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">API_key</span><span class="p">)</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="s1">&#39;https://api.thingspeak.com/update&#39;</span>
    <span class="n">API_key</span> <span class="o">=</span> <span class="s1">&#39;?api_key=&#39;</span> <span class="o">+</span> <span class="n">API_key</span>
    <span class="n">field</span> <span class="o">=</span> <span class="s1">&#39;&amp;field1=&#39;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="n">API_key</span> <span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="n">data</span>
    <span class="n">http_get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>


<p>Now let's write a script in a file called <strong><em>main.py</em></strong> which will use the functions in our <strong><em>wifitools.py</em></strong> and <strong><em>MCP9808.py</em></strong> files. This <strong><em>main.py</em></strong> script will import our MCP9808 and wifitools modules and use the <code>wifitools.connect()</code> function to connect the ESP8266 to a WiFi network. There is a <code>time.sleep(5)</code> line to allow the board time to connect to the WiFi network. Next we'll run a loop for a total of 8 hours (with 60 minutes in each hour). Inside the loop, we'll read the temperature off the MCP9808 using the <code>MCP9808.readtemp()</code> function and post the temperature to ThingSpeak.com using the <code>wifitools.thingspeak_post()</code> function. To read the temperature once a minute, we need to <code>time.sleep(60)</code> (wait 60 seconds) between each measurement. I also have one more <strong><em>.py</em></strong> file called <strong><em>config.py</em></strong>. This file simply contains three variables: <code>SSID</code>, <code>WIFI_PASSWORD</code> and <code>API_KEY</code>. By using a config file, we can keep our passwords and API keys out of version control. Like functions and classes, we can import variables defined in <strong><em>.py</em></strong> files for use in another script.</p>
<div class="highlight"><pre><span></span><span class="c1"># main.py</span>
<span class="c1"># Adafruit Feather Huzzah ESP8266 WiFi Weather Station</span>

<span class="kn">import</span> <span class="nn">wifitools</span>
<span class="kn">import</span> <span class="nn">MCP9808</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">config</span>

<span class="n">api_key</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">API_KEY</span>
<span class="n">ssid</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">SSID</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">WIFI_PASSWORD</span>

<span class="n">wifitools</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span><span class="n">password</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">60</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">MCP9808</span><span class="o">.</span><span class="n">readtemp</span><span class="p">()</span>
    <span class="n">wifitools</span><span class="o">.</span><span class="n">thingspeak_post</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
</pre></div>


<h3 id="3-upload-the-py-files-to-the-board-with-ampy">3. Upload the <strong><em>.py</em></strong> files to the board with <strong>ampy</strong></h3>
<p>Once all the <strong><em>.py</em></strong> files are created, ensure the Adafruit Feather Huzzah ESP8266 board is connected with a USB cable to the computer. You will also need to know what serial port the Feather board is connected to. We'll upload the code files to the board using <strong>ampy</strong>. Make sure you are in the directory with the <strong><em>.py</em></strong> files and that you are working in the <code>(micropython)</code> virtual environment that has <strong>ampy</strong> installed in it.</p>
<div class="highlight"><pre><span></span>$ conda activate micropython
<span class="o">(</span>micropython<span class="o">)</span>$ ampy --port COM4 put MCP9808.py
<span class="o">(</span>micropython<span class="o">)</span>$ ampy --port COM4 put wifitools.py
<span class="o">(</span>micropython<span class="o">)</span>$ ampy --port COM4 put main.py
<span class="o">(</span>micropython<span class="o">)</span>$ ampy --port COM4 put config.py
<span class="o">(</span>micropython<span class="o">)</span>$ ampy --port COM4 ls
boot.py
wifitools.py
MCP9808.py
config.py
main.py
</pre></div>


<h3 id="4-unplug-and-power-up-the-feather-huzzah-and-watch-the-data-on-thingspeakcom">4. Unplug and power up the Feather Huzzah and watch the data on ThingSpeak.com</h3>
<p>The Feather Huzzah needs to be restarted to run the code we just uploaded. To restart the board, unplug and then replug the board's power. Once power is restored, the board will run through the <strong><em>boot.py</em></strong> script then start the <strong><em>main.py</em></strong> script. When the board runs the <strong><em>main.py</em></strong> script, the board will connect to the WiFi network, read the temperature from the sensor then upload the temperature to ThingSpeak.com. If we go to ThingSpeak.com, we should see the temperature plotted on our Channel's page.</p>
<p><img alt="Channel Plot on ThingSpeak" src="./posts/micropython/channel_plot_on_ThingSpeak.png"></p>
<h3 id="congrats-you-have-a-working-weather-station-that-is-part-of-the-internet-of-things">Congrats! You have a working weather station that is part of the Internet of Things.</h3>
<p>Now you can read the temperature from anywhere in the world with an internet connection!</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="./micropython-temp-sensor.html">Using a Temperature Sensor with Micropython running on an Adafruit Feather Huzzah ESP8266</a></li>
        <li><a href="./upload-py-files-to-esp8266-running-micropython.html">How to upload .py-files onto an ESP8266 running MicroPython</a></li>
        <li><a href="./flask-iot-server-web-API.html">Building an IoT Server with flask and Python - Part 3 Web API</a></li>
        <li><a href="./micropython-wifi.html">Using Micropython to connect an Adafruit Feather Huzzah ESP8266 to WiFi</a></li>
        <li><a href="./micropython-install.html">Installing Micropython on an Adafruit Feather Huzzah ESP8266</a></li>
    </ul>
</section>
<section class="well" id="related-posts">
    <h4>Article 6 of the micropython series</h4>
       <h5>Previous articles</h5>
       <ul>
           <li><a href="./what-is-micropython.html">What is Micropython?</a></li>
           <li><a href="./micropython-install.html">Installing Micropython on an Adafruit Feather Huzzah ESP8266</a></li>
           <li><a href="./micropython-REPL.html">Using the Micropython REPL on an Adafruit Feather Huzzah ESP8266</a></li>
           <li><a href="./micropython-temp-sensor.html">Using a Temperature Sensor with Micropython running on an Adafruit Feather Huzzah ESP8266</a></li>
           <li><a href="./micropython-wifi.html">Using Micropython to connect an Adafruit Feather Huzzah ESP8266 to WiFi</a></li>
       </ul>
       <h5>Next articles</h5>
       <ul>
           <li><a href="./upload-py-files-to-esp8266-running-micropython.html">How to upload .py-files onto an ESP8266 running MicroPython</a></li>
       </ul>
</section>
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
    </div>
    <!-- AddThis Button END -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="./extra/gear-wrench-icon-512-278694.png"/>
        </p>
    <p>
      <strong>About Peter Kazarinoff</strong><br/>
        I teach engineering at a community college in the Pacific Northwest. I am interested in programming and how to help students. Here I mostly blog about Python, and how programing can be incorporated into engineering education.
    </p>
</div><!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./thoughts-on-how-to-test-science-code.html">Thoughts on Software Design in Scientific Code</a></li>
    <li class="list-group-item"><a href="./stream-S01-E01-jupyterhub-intro.html">My first Twitch Stream: S01-E01 JupyterHub Intro and Tools</a></li>
    <li class="list-group-item"><a href="./jupyterhub-deployment-on-running-in-production.html">Hear my story about deploying JupyterHub on the Running in Production Podcast</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="./"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group list-inline tagcloud" id="tags">
    <li class="list-group-item tag-2">
      <a href="./tag/engineering.html">engineering</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/esp8266.html">esp8266</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/flask.html">flask</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="./tag/jupyter.html">jupyter</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/jupyter-notebook.html">jupyter notebook</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="./tag/matplotlib.html">matplotlib</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/micropython.html">micropython</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/pelican.html">pelican</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="./tag/python.html">python</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/sensor.html">sensor</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->

<!-- Sidebar/Series -->
<li class="list-group-item">
  <h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Series</span></h4>
  <ul class="list-group">
    <li class="list-group-item">
      <h5></i>Previous article</h5>
      <a href="./micropython-wifi.html">Using Micropython to connect an Adafruit Feather Huzzah ESP8266 to WiFi</a>
    </li>
    <li class="list-group-item">
      <h5>Next article</h5>
      <a href="./upload-py-files-to-esp8266-running-micropython.html">How to upload .py-files onto an ESP8266 running MicroPython</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Series -->


<!-- Sidebar/Github -->
<li class="list-group-item">
  <h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
  <div id="gh_repos">
    <p class="list-group-item">Status updating...</p>
  </div>
  <a href="https://github.com/professorkazarinoff">@professorkazarinoff</a> on GitHub
</li>
<!-- End Sidebar/Github -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2021 Peter Kazarinoff
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>

    <script src="./static/js/custom.js"></script>


<!-- GitHub JS Code -->
<script type="text/javascript">
$(document).ready(function () {
  if (!window.jXHR) {
    var jxhr = document.createElement('script');
    jxhr.type = 'text/javascript';
    jxhr.src = './theme/js/jXHR.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(jxhr, s);
  }

  github.showRepos({
    user: 'professorkazarinoff',
    count: 5,
    skip_forks: true,
    target: '#gh_repos'
  });
});
</script>
<script src="./theme/js/github.js" type="text/javascript"></script>
<!-- End GitHub JS Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-116330557-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5cdd8eb4e16bf94c"></script>
</body>
</html>